<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë””í† ì±— â€” MBTI ë´‡ ëŒ€í™”</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f0f2f5;
      min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
      padding: 32px 16px 60px;
    }
    h1 { font-size: 1.9rem; color: #1a1a2e; margin-bottom: 4px; letter-spacing: -0.5px; }
    .subtitle { color: #999; margin-bottom: 22px; font-size: 0.9rem; }

    /* â”€â”€ ìŠ¤í… ì¸ë””ì¼€ì´í„° â”€â”€ */
    .stepper { display: flex; align-items: center; gap: 0; margin-bottom: 24px; }
    .s-dot {
      width: 28px; height: 28px; border-radius: 50%;
      background: #e0e0e0; color: #aaa;
      display: flex; align-items: center; justify-content: center;
      font-size: 0.72rem; font-weight: 700;
      transition: all 0.3s;
      flex-shrink: 0;
    }
    .s-dot.active { background: #6c63ff; color: white; }
    .s-dot.done   { background: #b0acff; color: white; }
    .s-line { width: 32px; height: 2px; background: #e0e0e0; transition: background 0.3s; }
    .s-line.done { background: #b0acff; }
    .s-label { font-size: 0.72rem; color: #aaa; margin-left: 8px; white-space: nowrap; }
    .s-label.active { color: #6c63ff; font-weight: 700; }

    /* â”€â”€ ì¹´ë“œ â”€â”€ */
    .card {
      background: white; border-radius: 16px; padding: 22px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      width: 100%; max-width: 480px; margin-bottom: 16px;
    }
    .card-title { font-weight: 700; font-size: 1rem; color: #1a1a2e; margin-bottom: 3px; }
    .card-sub   { font-size: 0.8rem; color: #bbb; margin-bottom: 18px; }

    /* â”€â”€ í¼ ìš”ì†Œ â”€â”€ */
    .row { display: flex; gap: 10px; margin-bottom: 14px; }
    .field { display: flex; flex-direction: column; gap: 5px; }
    .field.half { flex: 1; }
    .field.full  { width: 100%; margin-bottom: 14px; }
    .field label { font-size: 0.78rem; font-weight: 700; color: #777; }
    select, input[type=text] {
      padding: 10px 12px; border: 2px solid #ebebeb; border-radius: 10px;
      font-size: 0.92rem; background: white; color: #222;
      transition: border-color 0.2s; width: 100%;
    }
    select:focus, input:focus { outline: none; border-color: #6c63ff; }
    input::placeholder { color: #ccc; }

    /* â”€â”€ ì·¨ë¯¸ íƒœê·¸ â”€â”€ */
    .tags { display: flex; flex-wrap: wrap; gap: 7px; margin-top: 4px; }
    .tag {
      padding: 6px 12px; border: 2px solid #ebebeb; border-radius: 20px;
      font-size: 0.78rem; cursor: pointer; background: white;
      transition: all 0.15s; color: #666; user-select: none;
    }
    .tag:hover  { border-color: #b0acff; }
    .tag.on     { border-color: #6c63ff; background: #edeaff; color: #6c63ff; font-weight: 700; }

    /* â”€â”€ ì„±ê²© ìŠ¤íƒ€ì¼ (ë‹¨ì¼ ì„ íƒ íƒœê·¸) â”€â”€ */
    .style-tags { display: flex; flex-wrap: wrap; gap: 7px; margin-top: 4px; }
    .style-tag {
      padding: 6px 14px; border: 2px solid #ebebeb; border-radius: 20px;
      font-size: 0.78rem; cursor: pointer; background: white;
      transition: all 0.15s; color: #666; user-select: none;
    }
    .style-tag:hover { border-color: #b0acff; }
    .style-tag.on    { border-color: #6c63ff; background: #edeaff; color: #6c63ff; font-weight: 700; }

    /* â”€â”€ ë§íˆ¬ í†¤ ìŠ¬ë¼ì´ë” â”€â”€ */
    .tone-wrap { margin-top: 6px; }
    .tone-labels { display: flex; justify-content: space-between; font-size: 0.72rem; color: #aaa; margin-bottom: 4px; }
    .tone-value  { text-align: center; font-size: 0.78rem; color: #6c63ff; font-weight: 700; margin-top: 5px; }
    input[type=range] {
      width: 100%; accent-color: #6c63ff; cursor: pointer;
    }

    /* â”€â”€ í€´ì¦ˆ ì˜µì…˜ â”€â”€ */
    .quiz-section { margin-bottom: 18px; }
    .quiz-title { font-size: 0.85rem; font-weight: 700; color: #555; margin-bottom: 8px; }
    .opts { display: grid; grid-template-columns: 1fr 1fr; gap: 7px; }
    .opt-btn {
      padding: 11px 8px; border: 2px solid #ebebeb; border-radius: 10px;
      background: white; cursor: pointer; font-size: 0.78rem; text-align: center;
      transition: all 0.15s; color: #555; line-height: 1.4;
    }
    .opt-btn:hover   { border-color: #b0acff; }
    .opt-btn.selected { border-color: #6c63ff; background: #edeaff; color: #6c63ff; font-weight: 700; }
    .opt-emoji { font-size: 1.2rem; display: block; margin-bottom: 3px; }

    /* â”€â”€ ë²„íŠ¼ â”€â”€ */
    .btn {
      width: 100%; padding: 13px; background: #6c63ff; color: white;
      border: none; border-radius: 10px; font-size: 0.97rem; font-weight: 700;
      cursor: pointer; transition: background 0.2s, transform 0.15s;
    }
    .btn:hover:not(:disabled) { background: #574fd6; transform: translateY(-1px); }
    .btn:disabled { background: #c5c2f0; cursor: not-allowed; transform: none; }
    .btn-ghost {
      width: 100%; padding: 10px; background: transparent; color: #aaa;
      border: none; font-size: 0.82rem; cursor: pointer; margin-top: 6px;
    }
    .btn-ghost:hover { color: #6c63ff; }

    /* â”€â”€ ì±„íŒ… â”€â”€ */
    .chat-wrap { width: 100%; max-width: 600px; }
    .chat-box {
      background: white; border-radius: 16px; padding: 20px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
    }
    .chat-header {
      display: flex; justify-content: space-between; align-items: center;
      padding-bottom: 14px; margin-bottom: 18px; border-bottom: 1px solid #f2f2f2;
    }
    .chat-title { font-weight: 700; font-size: 0.95rem; color: #1a1a2e; }
    .badges { display: flex; gap: 8px; }
    .badge { padding: 4px 12px; border-radius: 20px; font-size: 0.72rem; font-weight: 700; }
    .badge-a { background: #edeaff; color: #6c63ff; }
    .badge-b { background: #ffe8e8; color: #ff6b6b; }

    .messages { display: flex; flex-direction: column; gap: 10px; }
    .msg { display: flex; align-items: flex-end; gap: 7px; }
    .msg.right { flex-direction: row-reverse; }

    .avatar {
      width: 34px; height: 34px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 0.6rem; flex-shrink: 0; letter-spacing: -0.5px;
    }
    .avatar-a { background: #edeaff; color: #6c63ff; }
    .avatar-b { background: #ffe8e8; color: #ff6b6b; }

    .bubble {
      max-width: 72%; padding: 10px 14px; border-radius: 18px;
      font-size: 0.875rem; line-height: 1.6; color: #333;
    }
    .bubble-a { background: #f5f3ff; border-bottom-left-radius: 4px; }
    .bubble-b { background: #fff3f3; border-bottom-right-radius: 4px; }

    /* ë°œì‹ ì ì´ë¦„ ë ˆì´ë¸” */
    .msg-group { display: flex; flex-direction: column; gap: 3px; max-width: 72%; }
    .sender-name { font-size: 0.68rem; color: #bbb; padding: 0 4px; }
    .msg.right .sender-name { text-align: right; }

    /* íƒ€ì´í•‘ ì»¤ì„œ */
    .cursor::after {
      content: '|'; display: inline-block; margin-left: 1px;
      animation: blink 0.6s infinite; color: #bbb; font-weight: 300;
    }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }

    /* íƒ€ì´í•‘ ì  */
    .dots-wrap {
      padding: 10px 14px; border-radius: 18px;
      display: flex; gap: 4px; align-items: center;
    }
    .dots-wrap.side-a { background: #f5f3ff; border-bottom-left-radius: 4px; }
    .dots-wrap.side-b { background: #fff3f3; border-bottom-right-radius: 4px; }
    .d { width: 5px; height: 5px; border-radius: 50%; background: #bbb; animation: bns 1.1s infinite; }
    .d:nth-child(2){animation-delay:.18s} .d:nth-child(3){animation-delay:.36s}
    @keyframes bns { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-5px)} }

    .hidden { display: none !important; }
    .divider { border: none; border-top: 1px solid #f0f0f0; margin: 14px 0; }
  </style>
</head>
<body>

<h1>ë””í† ì±— ğŸ’¬</h1>
<p class="subtitle">ë‚˜ì˜ ë””í† ì™€ ìƒëŒ€ë°©ì˜ ë””í† ê°€ ì²˜ìŒ ë§Œë‚˜ë©´?</p>

<!-- ìŠ¤í… ì¸ë””ì¼€ì´í„° -->
<div class="stepper" id="stepper">
  <div class="s-dot active" id="sd1">1</div>
  <div class="s-line" id="sl1"></div>
  <div class="s-dot" id="sd2">2</div>
  <div class="s-line" id="sl2"></div>
  <div class="s-dot" id="sd3">3</div>
  <div class="s-line" id="sl3"></div>
  <div class="s-dot" id="sd4">4</div>
  <span class="s-label active" id="stepLabel">MBTI ì„ íƒ</span>
</div>

<!-- â”€â”€â”€ Step 1: MBTI ì„ íƒ â”€â”€â”€ -->
<div class="card" id="step1">
  <div class="card-title">MBTI ì¡°í•© ì„ íƒ ğŸ‘€</div>
  <div class="card-sub">ì–´ë–¤ ë‘ ì„±ê²©ì´ ëŒ€í™”í• ì§€ ì •í•´ë´</div>
  <div class="row">
    <div class="field half">
      <label>ë‚˜ì˜ MBTI</label>
      <select id="mbti1"></select>
    </div>
  </div>
  <p style="font-size:0.78rem;color:#aaa;margin-top:-6px;margin-bottom:14px;">ìƒëŒ€ë°©ì€ ê¶í•© ëª©ë¡ì—ì„œ ìë™ ë§¤ì¹­ë¼ìš” âœ¨</p>
  <button class="btn" onclick="go(2)">ë‹¤ìŒ â†’</button>
</div>

<!-- â”€â”€â”€ Step 2: ë‚˜ì˜ í”„ë¡œí•„ â”€â”€â”€ -->
<div class="card hidden" id="step2">
  <div class="card-title">ë‚˜ì˜ í”„ë¡œí•„ ğŸ™‹</div>
  <div class="card-sub">ë” ë‚˜ë‹¤ìš´ ë””í† ë¥¼ ë§Œë“¤ì–´ì¤„ ê±°ì•¼</div>

  <div class="row">
    <div class="field half">
      <label>ìƒë…„ì›”ì¼</label>
      <input type="text" id="a_birth" placeholder="YYYY-MM-DD" maxlength="10"
        oninput="formatBirthInput(this)">
    </div>
    <div class="field half">
      <label>ê±°ì£¼ì§€</label>
      <select id="a_city">
        <option value="">ì„ íƒ</option>
        <option>ì„œìš¸</option>
        <option>ê²½ê¸°/ì¸ì²œ</option>
        <option>ë¶€ì‚°</option>
        <option>ëŒ€êµ¬/ê²½ë¶</option>
        <option>ê´‘ì£¼/ì „ë¼</option>
        <option>ê¸°íƒ€ ì§€ë°©</option>
      </select>
    </div>
  </div>

  <div class="field full">
    <label>ì§ì—…/ìƒí™©</label>
    <select id="a_job" onchange="toggleDetail('a')">
      <option value="">ì„ íƒ</option>
      <option value="ê³ ë“±í•™ìƒ">ê³ ë“±í•™ìƒ</option>
      <option value="ëŒ€í•™ìƒ">ëŒ€í•™ìƒ</option>
      <option value="ì·¨ì¤€ìƒ">ì·¨ì¤€ìƒ (êµ¬ì§ ì¤‘)</option>
      <option value="ì§ì¥ì¸">ì§ì¥ì¸</option>
      <option value="í”„ë¦¬ëœì„œ">í”„ë¦¬ëœì„œ</option>
      <option value="ìì˜ì—…ì">ìì˜ì—…ì</option>
      <option value="ê¸°íƒ€">ê¸°íƒ€</option>
    </select>
  </div>

  <!-- ì¡°ê±´ë¶€: ëŒ€í•™ìƒ/ì§ì¥ì¸/ê¸°íƒ€ì¼ ë•Œ ì„¸ë¶€ ì •ë³´ -->
  <div class="field full hidden" id="a_detail_wrap">
    <label id="a_detail_label">ì„¸ë¶€ ì •ë³´</label>
    <input type="text" id="a_detail" placeholder="ì˜ˆ: ê²½ì˜í•™ê³¼ 2í•™ë…„" maxlength="40">
  </div>

  <hr class="divider">

  <div class="field full">
    <label>ì·¨ë¯¸ (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)</label>
    <div class="tags" id="a_hobbies_tags">
      <span class="tag" data-val="ìš´ë™/í—¬ìŠ¤">ğŸƒ ìš´ë™/í—¬ìŠ¤</span>
      <span class="tag" data-val="ê²Œì„">ğŸ® ê²Œì„</span>
      <span class="tag" data-val="ìœ íŠœë¸Œ/ë„·í”Œë¦­ìŠ¤">ğŸ“º ìœ íŠœë¸Œ/ë„·í”Œ</span>
      <span class="tag" data-val="ë…ì„œ">ğŸ“š ë…ì„œ</span>
      <span class="tag" data-val="ìŒì•…ê°ìƒ">ğŸµ ìŒì•…ê°ìƒ</span>
      <span class="tag" data-val="ìš”ë¦¬/ë§›ì§‘">ğŸ³ ìš”ë¦¬/ë§›ì§‘</span>
      <span class="tag" data-val="ì—¬í–‰">âœˆï¸ ì—¬í–‰</span>
      <span class="tag" data-val="ì¹´í˜">â˜• ì¹´í˜</span>
      <span class="tag" data-val="ì‡¼í•‘">ğŸ›ï¸ ì‡¼í•‘</span>
      <span class="tag" data-val="ê·¸ë¦¼/ì°½ì‘">ğŸ¨ ê·¸ë¦¼/ì°½ì‘</span>
    </div>
  </div>

  <hr class="divider">

  <div class="card-title" style="font-size:0.9rem;margin-bottom:14px;">ì„±ê²© ìŠ¤íƒ€ì¼ âœ¨</div>

  <div class="field full">
    <label>ëŒ€í™” ìŠ¤íƒ€ì¼</label>
    <div class="style-tags" id="a_convStyle_tags">
      <span class="style-tag" data-val="ë¨¼ì € ë§ì„ ê±°ëŠ” í¸ì´ì•¼">ğŸ’¬ ë¨¼ì € ë§ ê±°ëŠ” í¸</span>
      <span class="style-tag" data-val="ë“£ëŠ” í¸ì´ì•¼">ğŸ‘‚ ë“£ëŠ” í¸</span>
      <span class="style-tag" data-val="ìƒí™©ì— ë”°ë¼ ë‹¬ë¼">ğŸ”„ ìƒí™©ë”°ë¼ ë‹¬ë¼</span>
    </div>
  </div>

  <div class="field full">
    <label>ê°ì • í‘œí˜„ ë°©ì‹</label>
    <div class="style-tags" id="a_emotionStyle_tags">
      <span class="style-tag" data-val="ê°ì •ì„ ë°”ë¡œ í‘œí˜„í•˜ëŠ” í¸ì´ì•¼">ğŸ˜Š ë°”ë¡œ í‘œí˜„í•˜ëŠ” í¸</span>
      <span class="style-tag" data-val="ê°ì •ì„ ì‚­íˆëŠ” í¸ì´ì•¼">ğŸ˜¶ ì‚­íˆëŠ” í¸</span>
      <span class="style-tag" data-val="ê°ì • í‘œí˜„ì´ ì¤‘ê°„ì´ì•¼">ğŸ˜ ì¤‘ê°„</span>
    </div>
  </div>

  <div class="field full">
    <label>ë§íˆ¬ í†¤</label>
    <div class="tone-wrap">
      <div class="tone-labels"><span>ğŸ˜„ ìœ ì¾Œí•¨</span><span>ğŸ§ ì§„ì§€í•¨</span></div>
      <input type="range" id="a_tone_slider" min="0" max="100" value="50" oninput="updateToneLabel(this.value)">
      <div class="tone-value" id="a_tone_label">ìœ ì¾Œí•¨ 50% Â· ì§„ì§€í•¨ 50%</div>
    </div>
  </div>

  <button class="btn" onclick="go(3)">ë‹¤ìŒ â†’</button>
  <button class="btn-ghost" onclick="go(1)">â† ì´ì „</button>
</div>

<!-- â”€â”€â”€ Step 3: ìƒëŒ€ë°© í”„ë¡œí•„ â”€â”€â”€ -->
<div class="card hidden" id="step3">
  <div class="card-title">ìƒëŒ€ë°© í”„ë¡œí•„ ğŸ¤”</div>
  <div class="card-sub">ìƒëŒ€ë°©ì´ ì–´ë–¤ ì‚¬ëŒì¸ì§€ ì„¤ì •í•´ì¤˜ (ì„ íƒì‚¬í•­)</div>

  <div class="row">
    <div class="field half">
      <label>ì—°ë ¹ëŒ€</label>
      <select id="b_age">
        <option value="">ëª¨ë¦„/ë¹„ìŠ·</option>
        <option>10ëŒ€</option>
        <option>20ëŒ€ ì´ˆë°˜</option>
        <option>20ëŒ€ í›„ë°˜</option>
        <option>30ëŒ€</option>
        <option>40ëŒ€ ì´ìƒ</option>
      </select>
    </div>
    <div class="field half">
      <label>ì§ì—…/ìƒí™©</label>
      <select id="b_job" onchange="toggleDetail('b')">
        <option value="">ëª¨ë¦„/ììœ </option>
        <option value="ê³ ë“±í•™ìƒ">ê³ ë“±í•™ìƒ</option>
        <option value="ëŒ€í•™ìƒ">ëŒ€í•™ìƒ</option>
        <option value="ì·¨ì¤€ìƒ">ì·¨ì¤€ìƒ</option>
        <option value="ì§ì¥ì¸">ì§ì¥ì¸</option>
        <option value="í”„ë¦¬ëœì„œ">í”„ë¦¬ëœì„œ</option>
        <option value="ìì˜ì—…ì">ìì˜ì—…ì</option>
      </select>
    </div>
  </div>

  <div class="field full hidden" id="b_detail_wrap">
    <label id="b_detail_label">ì„¸ë¶€ ì •ë³´</label>
    <input type="text" id="b_detail" placeholder="ì˜ˆ: ì»´í“¨í„°ê³µí•™ê³¼ 3í•™ë…„" maxlength="40">
  </div>

  <button class="btn" onclick="go(4)">ë‹¤ìŒ â†’</button>
  <button class="btn-ghost" onclick="go(2)">â† ì´ì „</button>
</div>

<!-- â”€â”€â”€ Step 4: ì˜¤ëŠ˜ ê¸°ë¶„ â”€â”€â”€ -->
<div class="card hidden" id="step4">
  <div class="card-title">ì˜¤ëŠ˜ì˜ ë‚˜ ğŸª</div>
  <div class="card-sub">ëŒ€í™”ê°€ ë” ë‚˜ë‹µê²Œ í˜ëŸ¬ê°ˆ ê±°ì•¼</div>

  <div class="quiz-section">
    <div class="quiz-title">â‘  ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ í•œë§ˆë””ë¡œ?</div>
    <div class="opts" data-q="q1">
      <button class="opt-btn" data-val="A"><span class="opt-emoji">ğŸ˜¤</span>ì •ì‹ ì—†ì´ ë°”ë¹´ì–´</button>
      <button class="opt-btn" data-val="B"><span class="opt-emoji">ğŸ˜Œ</span>ì—¬ìœ ë¡­ê³  í‰ì˜¨í–ˆì–´</button>
      <button class="opt-btn" data-val="C"><span class="opt-emoji">ğŸ˜©</span>í˜ë“¤ê³  ì§€ì³¤ì–´</button>
      <button class="opt-btn" data-val="D"><span class="opt-emoji">ğŸ˜„</span>ê¸°ë¶„ ì¢‹ì€ ì¼ ìˆì—ˆì–´</button>
    </div>
  </div>

  <div class="quiz-section">
    <div class="quiz-title">â‘¡ ì§€ê¸ˆ ê°€ì¥ í•˜ê³  ì‹¶ì€ ê±´?</div>
    <div class="opts" data-q="q2">
      <button class="opt-btn" data-val="A"><span class="opt-emoji">ğŸ•</span>ë§›ìˆëŠ” ê±° ë¨¹ê¸°</button>
      <button class="opt-btn" data-val="B"><span class="opt-emoji">ğŸ›‹ï¸</span>ê·¸ëƒ¥ ëˆ„ì›Œì„œ ì‰¬ê¸°</button>
      <button class="opt-btn" data-val="C"><span class="opt-emoji">ğŸ®</span>ì¬ë¯¸ìˆëŠ” ê±° í•˜ê¸°</button>
      <button class="opt-btn" data-val="D"><span class="opt-emoji">ğŸ’¬</span>ëˆ„êµ°ê°€ë‘ ìˆ˜ë‹¤ ë–¨ê¸°</button>
    </div>
  </div>

  <div class="quiz-section">
    <div class="quiz-title">â‘¢ ì˜¤ëŠ˜ ë‚˜ë¥¼ ê°€ì¥ ì˜ í‘œí˜„í•˜ëŠ” ê±´?</div>
    <div class="opts" data-q="q3">
      <button class="opt-btn" data-val="A"><span class="opt-emoji">ğŸ”¥</span>ì—´ì • ê°€ë“</button>
      <button class="opt-btn" data-val="B"><span class="opt-emoji">ğŸ§Š</span>ì°¨ë¶„í•˜ê³  ëƒ‰ì •</button>
      <button class="opt-btn" data-val="C"><span class="opt-emoji">ğŸŒŠ</span>ê°ì„± ì¶©ë§Œ</button>
      <button class="opt-btn" data-val="D"><span class="opt-emoji">ğŸ’¡</span>ì•„ì´ë””ì–´ ë„˜ì¹¨</button>
    </div>
  </div>

  <button class="btn" onclick="startChat()">ëŒ€í™” ì‹œì‘í•˜ê¸° âœ¨</button>
  <button class="btn-ghost" onclick="go(3)">â† ì´ì „</button>
</div>

<!-- â”€â”€â”€ ì±„íŒ… â”€â”€â”€ -->
<div class="chat-wrap hidden" id="chatWrap">
  <div class="chat-box">
    <div class="chat-header">
      <span class="chat-title" id="chatTitle">ì‹¤ì‹œê°„ ëŒ€í™” ì¤‘...</span>
      <div class="badges">
        <span class="badge badge-a" id="label1"></span>
        <span class="badge badge-b" id="label2"></span>
      </div>
    </div>
    <div class="messages" id="messages"></div>
  </div>
  <button class="btn-ghost" style="width:100%;margin-top:12px;" onclick="restart()">â†º ë‹¤ì‹œ ì„¤ì •í•˜ê¸°</button>
</div>

<script>
/* â”€â”€ MBTI ì…€ë ‰íŠ¸ ì´ˆê¸°í™” â”€â”€ */
const MBTI_LIST = ['ENFP','ENFJ','ENTP','ENTJ','INFP','INFJ','INTP','INTJ','ESFP','ESFJ','ESTP','ESTJ','ISFP','ISFJ','ISTP','ISTJ'];
const sel1 = document.getElementById('mbti1');
MBTI_LIST.forEach(m => {
  const o = document.createElement('option');
  o.value = o.textContent = m;
  if (m === 'ENFP') o.selected = true;
  sel1.appendChild(o);
});

/* â”€â”€ ê¶í•© ëª©ë¡ (ëœë¤ ìë™ ë§¤ì¹­) â”€â”€ */
const COMPATIBILITY = {
  ENFP: ['INFJ','INTJ','ENFJ'],  ENTP: ['INFP','INTP','ENFP'],
  ENFJ: ['INFP','ISFP','ENFP'],  ENTJ: ['INTP','INTJ','INFJ'],
  ESFP: ['ISFJ','ISTJ','ESFJ'],  ESTP: ['ISTP','ISTJ','ESTJ'],
  ESFJ: ['ISFP','ISFJ','ESFP'],  ESTJ: ['ISTJ','ISTP','ESTP'],
  INFJ: ['ENFP','ENTP','ENFJ'],  INTJ: ['ENFP','ENTJ','ENTP'],
  INFP: ['ENFJ','ENTP','ENFP'],  INTP: ['ENTJ','ENTP','ESTJ'],
  ISFJ: ['ESFP','ESTP','ESFJ'],  ISTJ: ['ESFP','ESTP','ESTJ'],
  ISFP: ['ENFJ','ESFJ','ESFP'],  ISTP: ['ESTP','ESTJ','ENTJ'],
};
function pickMatch(mbti) {
  const list = COMPATIBILITY[mbti] || MBTI_LIST;
  return list[Math.floor(Math.random() * list.length)];
}

/* â”€â”€ ìƒë…„ì›”ì¼ â†’ ë‚˜ì´ & ì„¸ëŒ€ ìŠ¤íƒ€ì¼ â”€â”€ */
function formatBirthInput(el) {
  let v = el.value.replace(/\D/g, '');
  if (v.length > 4)  v = v.slice(0,4) + '-' + v.slice(4);
  if (v.length > 7)  v = v.slice(0,7) + '-' + v.slice(7);
  el.value = v.slice(0, 10);
}
function calcAgeAndGen(birthStr) {
  if (!birthStr || birthStr.length < 10) return { ageStr: '', genStyle: '' };
  const today = new Date();
  const birth = new Date(birthStr);
  if (isNaN(birth.getTime())) return { ageStr: '', genStyle: '' };
  let age = today.getFullYear() - birth.getFullYear();
  const m = today.getMonth() - birth.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
  const year = birth.getFullYear();
  let genStyle = '';
  if (year >= 2000) {
    genStyle = 'ì‹ ì¡°ì–´ì™€ ì¤„ì„ë§ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì“°ê³ , ì§§ì€ ë¬¸ì¥ìœ¼ë¡œ ë§í•´. ë°ˆì´ë‚˜ ìœ í–‰ì–´ì— ë°˜ì‘í•´.';
  } else if (year >= 1990) {
    genStyle = 'ì´ëª¨í‹°ì½˜ì„ ì ì ˆíˆ ì“°ê³ , ì§ì¥ ìƒí™œì´ë‚˜ ì‚¬íšŒìƒí™œì— ê³µê°í•˜ëŠ” ì´ì•¼ê¸°ë¥¼ í•´.';
  } else if (year >= 1980) {
    genStyle = 'ìœ¡ì•„ë‚˜ ì¬í…Œí¬ ê°™ì€ ì†Œì¬ì— ê³µê°í•˜ê³ , ë¬¸ì¥í˜•ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ë§í•´.';
  } else {
    genStyle = 'ê²©ì‹ê³¼ êµ¬ì–´ì²´ë¥¼ ì ì ˆíˆ í˜¼ìš©í•˜ê³ , ê²½í—˜ë‹´ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì´ì•¼ê¸°í•´.';
  }
  return { ageStr: `${age}ì‚´`, genStyle };
}

/* â”€â”€ ì§ì—… ì„ íƒ â†’ ì„¸ë¶€ì •ë³´ í† ê¸€ â”€â”€ */
const DETAIL_LABELS = {
  'ëŒ€í•™ìƒ': 'ì „ê³µ & í•™ë…„  (ì˜ˆ: ê²½ì˜í•™ê³¼ 2í•™ë…„)',
  'ì§ì¥ì¸': 'ì§ì¢… & íšŒì‚¬ ê·œëª¨  (ì˜ˆ: ITìŠ¤íƒ€íŠ¸ì—… ê°œë°œì)',
  'ê³ ë“±í•™ìƒ': 'í•™êµ íŠ¹ì§•  (ì˜ˆ: ì˜ˆìˆ ê³  2í•™ë…„)',
  'ì·¨ì¤€ìƒ': 'ì¤€ë¹„ ë¶„ì•¼  (ì˜ˆ: ê³µë¬´ì› ì‹œí—˜ ì¤€ë¹„ ì¤‘)',
  'í”„ë¦¬ëœì„œ': 'ì£¼ìš” ì—…ë¬´  (ì˜ˆ: ì˜ìƒí¸ì§‘ í”„ë¦¬ëœì„œ)',
  'ìì˜ì—…ì': 'ì—…ì¢…  (ì˜ˆ: ì¹´í˜ ìš´ì˜)',
  'ê¸°íƒ€': 'í•˜ëŠ” ì¼  (ììœ  ì…ë ¥)',
};
function toggleDetail(prefix) {
  const job  = document.getElementById(`${prefix}_job`).value;
  const wrap  = document.getElementById(`${prefix}_detail_wrap`);
  const label = document.getElementById(`${prefix}_detail_label`);
  const show  = !!job && job !== '';
  wrap.classList.toggle('hidden', !show);
  if (show) {
    label.textContent = DETAIL_LABELS[job] || 'ì„¸ë¶€ ì •ë³´';
    document.getElementById(`${prefix}_detail`).placeholder =
      job === 'ëŒ€í•™ìƒ' ? 'ì˜ˆ: ê²½ì˜í•™ê³¼ 2í•™ë…„' :
      job === 'ì§ì¥ì¸' ? 'ì˜ˆ: ITìŠ¤íƒ€íŠ¸ì—… ê°œë°œì' :
      job === 'ì·¨ì¤€ìƒ' ? 'ì˜ˆ: ê³µë¬´ì› ì‹œí—˜ ì¤€ë¹„ ì¤‘' : 'ììœ  ì…ë ¥';
  }
}

/* â”€â”€ ì·¨ë¯¸ íƒœê·¸ í† ê¸€ (ë‹¤ì¤‘ ì„ íƒ) â”€â”€ */
document.querySelectorAll('#a_hobbies_tags .tag').forEach(tag => {
  tag.addEventListener('click', () => tag.classList.toggle('on'));
});

/* â”€â”€ ì„±ê²© ìŠ¤íƒ€ì¼ íƒœê·¸ í† ê¸€ (ë‹¨ì¼ ì„ íƒ) â”€â”€ */
['a_convStyle_tags', 'a_emotionStyle_tags'].forEach(groupId => {
  document.querySelectorAll(`#${groupId} .style-tag`).forEach(tag => {
    tag.addEventListener('click', () => {
      document.querySelectorAll(`#${groupId} .style-tag`).forEach(t => t.classList.remove('on'));
      tag.classList.add('on');
    });
  });
});

/* â”€â”€ ë§íˆ¬ í†¤ ìŠ¬ë¼ì´ë” â”€â”€ */
function updateToneLabel(val) {
  const fun = parseInt(val);
  const ser = 100 - fun;
  document.getElementById('a_tone_label').textContent = `ìœ ì¾Œí•¨ ${fun}% Â· ì§„ì§€í•¨ ${ser}%`;
}

/* â”€â”€ í€´ì¦ˆ ì„ íƒ â”€â”€ */
const answers = { q1: null, q2: null, q3: null };
document.querySelectorAll('.opts').forEach(group => {
  group.querySelectorAll('.opt-btn').forEach(btn => {
    btn.addEventListener('click', () => {
      group.querySelectorAll('.opt-btn').forEach(b => b.classList.remove('selected'));
      btn.classList.add('selected');
      answers[group.dataset.q] = btn.dataset.val;
    });
  });
});

/* â”€â”€ ìŠ¤í… ì´ë™ â”€â”€ */
const STEP_LABELS = ['', 'MBTI ì„ íƒ', 'ë‚˜ì˜ í”„ë¡œí•„', 'ìƒëŒ€ë°© í”„ë¡œí•„', 'ì˜¤ëŠ˜ì˜ ë‚˜'];
function go(n) {
  for (let i = 1; i <= 4; i++) {
    document.getElementById(`step${i}`)?.classList.toggle('hidden', i !== n);
  }
  document.getElementById('chatWrap').classList.add('hidden');
  document.getElementById('stepper').classList.remove('hidden');

  for (let i = 1; i <= 4; i++) {
    const dot  = document.getElementById(`sd${i}`);
    const line = document.getElementById(`sl${i}`);
    dot?.classList.toggle('active', i === n);
    dot?.classList.toggle('done',   i <  n);
    line?.classList.toggle('done',  i <  n);
  }
  const lbl = document.getElementById('stepLabel');
  lbl.textContent = STEP_LABELS[n];
  lbl.className = 's-label active';
}

/* â”€â”€ ìœ í‹¸ â”€â”€ */
const sleep = ms => new Promise(r => setTimeout(r, ms));
const esc   = s  => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

/* â”€â”€ íƒ€ì´í•‘ ì• ë‹ˆë©”ì´ì…˜ â”€â”€ */
async function typeText(el, text) {
  el.textContent = '';
  el.classList.add('cursor');
  for (const ch of text) {
    el.textContent += ch;
    el.scrollIntoView({ block: 'end' });
    await sleep(26 + Math.random() * 22);
  }
  el.classList.remove('cursor');
}

/* â”€â”€ ë©”ì‹œì§€ í â”€â”€ */
const queue = [];
let busy = false, isDone = false;
let M1 = '', M2 = '';
let M1name = '', M2name = '';

async function processQueue() {
  if (busy || queue.length === 0) return;
  busy = true;
  removeTypingDots();

  const { mbti, text, isA, senderName } = queue.shift();
  const msgs = document.getElementById('messages');

  const row   = document.createElement('div');
  row.className = `msg ${isA ? '' : 'right'}`;

  const av = document.createElement('div');
  av.className = `avatar ${isA ? 'avatar-a' : 'avatar-b'}`;
  av.textContent = mbti;

  const group = document.createElement('div');
  group.className = 'msg-group';

  const name = document.createElement('div');
  name.className = 'sender-name';
  name.textContent = senderName;

  const bub = document.createElement('div');
  bub.className = `bubble ${isA ? 'bubble-a' : 'bubble-b'}`;

  group.appendChild(name);
  group.appendChild(bub);
  row.appendChild(av);
  row.appendChild(group);
  msgs.appendChild(row);
  row.scrollIntoView({ behavior: 'smooth', block: 'end' });

  await typeText(bub, text);
  busy = false;

  if (queue.length > 0) {
    addTypingDots(!queue[0].isA);
    await sleep(180);
    processQueue();
  } else if (!isDone) {
    addTypingDots(!isA);
  }
}

function addTypingDots(isA) {
  removeTypingDots();
  const msgs = document.getElementById('messages');
  const row  = document.createElement('div');
  row.id = 'typing-dots';
  row.className = `msg ${isA ? '' : 'right'}`;
  row.innerHTML = `
    <div class="avatar ${isA ? 'avatar-a' : 'avatar-b'}">${esc(isA ? M1 : M2)}</div>
    <div class="dots-wrap ${isA ? 'side-a' : 'side-b'}">
      <div class="d"></div><div class="d"></div><div class="d"></div>
    </div>`;
  msgs.appendChild(row);
  row.scrollIntoView({ behavior: 'smooth', block: 'end' });
}
function removeTypingDots() { document.getElementById('typing-dots')?.remove(); }

/* â”€â”€ ì±„íŒ… ì‹œì‘ â”€â”€ */
let currentSrc = null;

function startChat() {
  M1 = document.getElementById('mbti1').value;
  M2 = pickMatch(M1);  // ê¶í•© ëª©ë¡ì—ì„œ ëœë¤ ìë™ ë§¤ì¹­

  // ë‚˜ì˜ í”„ë¡œí•„ ìˆ˜ì§‘
  const a_birth  = document.getElementById('a_birth').value.trim();
  const { ageStr: a_age, genStyle: a_genStyle } = calcAgeAndGen(a_birth);
  const a_city   = document.getElementById('a_city').value;
  const a_job    = document.getElementById('a_job').value;
  const a_detail = document.getElementById('a_detail').value.trim();
  const a_hobbies = [...document.querySelectorAll('#a_hobbies_tags .tag.on')]
                      .map(t => t.dataset.val).join(',');

  // ìƒëŒ€ë°© í”„ë¡œí•„ ìˆ˜ì§‘
  const b_age    = document.getElementById('b_age').value;
  const b_job    = document.getElementById('b_job').value;
  const b_detail = document.getElementById('b_detail').value.trim();

  // ì„±ê²© ìŠ¤íƒ€ì¼ ìˆ˜ì§‘
  const a_convStyle    = document.querySelector('#a_convStyle_tags .style-tag.on')?.dataset.val || '';
  const a_emotionStyle = document.querySelector('#a_emotionStyle_tags .style-tag.on')?.dataset.val || '';
  const toneVal = document.getElementById('a_tone_slider').value;
  const a_tone = `ìœ ì¾Œí•¨ ${toneVal}%, ì§„ì§€í•¨ ${100 - toneVal}%`;

  // ë°œì‹ ì ì´ë¦„ ë ˆì´ë¸”
  M1name = [a_age, a_city, a_job].filter(Boolean).join(' Â· ') || M1;
  M2name = [b_age, b_job].filter(Boolean).join(' Â· ') || M2;

  // UI ì „í™˜
  document.getElementById('step4').classList.add('hidden');
  document.getElementById('stepper').classList.add('hidden');
  document.getElementById('chatWrap').classList.remove('hidden');
  document.getElementById('label1').textContent = M1;
  document.getElementById('label2').textContent = M2;
  document.getElementById('messages').innerHTML = '';
  document.getElementById('chatTitle').textContent = `${M1} Ã— ${M2} ì‹¤ì‹œê°„ ëŒ€í™” ì¤‘...`;

  queue.length = 0; busy = false; isDone = false;
  addTypingDots(true);

  // SSE íŒŒë¼ë¯¸í„° êµ¬ì„±
  const p = new URLSearchParams({ mbti1: M1, mbti2: M2 });
  if (a_age)     p.set('a_age', a_age);
  if (a_city)    p.set('a_city', a_city);
  if (a_job)     p.set('a_job', a_job);
  if (a_detail)  p.set('a_detail', a_detail);
  if (a_hobbies)      p.set('a_hobbies', a_hobbies);
  if (a_convStyle)    p.set('a_convStyle', a_convStyle);
  if (a_emotionStyle) p.set('a_emotionStyle', a_emotionStyle);
  p.set('a_tone', a_tone);
  if (a_genStyle)     p.set('a_genStyle', a_genStyle);
  if (b_age)     p.set('b_age', b_age);
  if (b_job)     p.set('b_job', b_job);
  if (b_detail)  p.set('b_detail', b_detail);
  if (answers.q1) p.set('q1', answers.q1);
  if (answers.q2) p.set('q2', answers.q2);
  if (answers.q3) p.set('q3', answers.q3);

  if (currentSrc) currentSrc.close();
  const src = new EventSource(`/api/stream?${p}`);
  currentSrc = src;

  src.onmessage = (e) => {
    const data = JSON.parse(e.data);

    if (data.done) {
      isDone = true;
      if (!busy && queue.length === 0) {
        removeTypingDots();
        document.getElementById('chatTitle').textContent = 'ëŒ€í™” ì™„ë£Œ âœ…';
      }
      src.close(); return;
    }
    if (data.error) {
      removeTypingDots();
      const d = document.createElement('div');
      d.style.cssText = 'text-align:center;color:#e74c3c;padding:16px;font-size:0.82rem;';
      d.textContent = 'ì˜¤ë¥˜: ' + data.error;
      document.getElementById('messages').appendChild(d);
      src.close(); return;
    }
    if (data.mbti && data.text) {
      const isA = data.mbti === M1;
      queue.push({ mbti: data.mbti, text: data.text, isA, senderName: isA ? M1name : M2name });
      processQueue();
    }
  };

  src.onerror = () => { removeTypingDots(); src.close(); };
}

/* â”€â”€ ì™„ë£Œ í›„ title ì—…ë°ì´íŠ¸ â”€â”€ */
setInterval(() => {
  if (isDone && !busy && queue.length === 0) {
    removeTypingDots();
    const t = document.getElementById('chatTitle');
    if (t && t.textContent.includes('ì‹¤ì‹œê°„ ëŒ€í™” ì¤‘...')) t.textContent = `${M1} Ã— ${M2} ëŒ€í™” ì™„ë£Œ âœ…`;
  }
}, 300);

/* â”€â”€ ë‹¤ì‹œ ì„¤ì • â”€â”€ */
function restart() {
  if (currentSrc) currentSrc.close();
  go(1);
}
</script>
</body>
</html>
