<!DOCTYPE html>
<html lang="ko">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë””í† ì±— â€” MBTI ë´‡ ëŒ€í™”</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f0f2f5;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 32px 16px 60px;
    }

    h1 {
      font-size: 1.9rem;
      color: #1a1a2e;
      margin-bottom: 4px;
      letter-spacing: -0.5px;
    }

    .subtitle {
      color: #999;
      margin-bottom: 22px;
      font-size: 0.9rem;
    }

    /* â”€â”€ ìŠ¤í… ì¸ë””ì¼€ì´í„° â”€â”€ */
    .stepper {
      display: flex;
      align-items: center;
      gap: 0;
      margin-bottom: 24px;
    }

    .s-dot {
      width: 28px;
      height: 28px;
      border-radius: 50%;
      background: #e0e0e0;
      color: #aaa;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.72rem;
      font-weight: 700;
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .s-dot.active {
      background: #6c63ff;
      color: white;
    }

    .s-dot.done {
      background: #b0acff;
      color: white;
    }

    .s-line {
      width: 32px;
      height: 2px;
      background: #e0e0e0;
      transition: background 0.3s;
    }

    .s-line.done {
      background: #b0acff;
    }

    .s-label {
      font-size: 0.72rem;
      color: #aaa;
      margin-left: 8px;
      white-space: nowrap;
    }

    .s-label.active {
      color: #6c63ff;
      font-weight: 700;
    }

    /* â”€â”€ ì¹´ë“œ â”€â”€ */
    .card {
      background: white;
      border-radius: 16px;
      padding: 22px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
      width: 100%;
      max-width: 480px;
      margin-bottom: 16px;
    }

    .card-title {
      font-weight: 700;
      font-size: 1rem;
      color: #1a1a2e;
      margin-bottom: 3px;
    }

    .card-sub {
      font-size: 0.8rem;
      color: #bbb;
      margin-bottom: 18px;
    }

    /* â”€â”€ í¼ ìš”ì†Œ â”€â”€ */
    .row {
      display: flex;
      gap: 10px;
      margin-bottom: 14px;
    }

    .field {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }

    .field.half {
      flex: 1;
    }

    .field.full {
      width: 100%;
      margin-bottom: 14px;
    }

    .field label {
      font-size: 0.78rem;
      font-weight: 700;
      color: #777;
    }

    select,
    input[type=text] {
      padding: 10px 12px;
      border: 2px solid #ebebeb;
      border-radius: 10px;
      font-size: 0.92rem;
      background: white;
      color: #222;
      transition: border-color 0.2s;
      width: 100%;
    }

    select:focus,
    input:focus {
      outline: none;
      border-color: #6c63ff;
    }

    input::placeholder {
      color: #ccc;
    }

    /* â”€â”€ ì·¨ë¯¸ íƒœê·¸ â”€â”€ */
    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
      margin-top: 4px;
    }

    .tag {
      padding: 6px 12px;
      border: 2px solid #ebebeb;
      border-radius: 20px;
      font-size: 0.78rem;
      cursor: pointer;
      background: white;
      transition: all 0.15s;
      color: #666;
      user-select: none;
    }

    .tag:hover {
      border-color: #b0acff;
    }

    .tag.on {
      border-color: #6c63ff;
      background: #edeaff;
      color: #6c63ff;
      font-weight: 700;
    }

    /* â”€â”€ ì„±ê²© ìŠ¤íƒ€ì¼ (ë‹¨ì¼ ì„ íƒ íƒœê·¸) â”€â”€ */
    .style-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 7px;
      margin-top: 4px;
    }

    .style-tag {
      padding: 6px 14px;
      border: 2px solid #ebebeb;
      border-radius: 20px;
      font-size: 0.78rem;
      cursor: pointer;
      background: white;
      transition: all 0.15s;
      color: #666;
      user-select: none;
    }

    .style-tag:hover {
      border-color: #b0acff;
    }

    .style-tag.on {
      border-color: #6c63ff;
      background: #edeaff;
      color: #6c63ff;
      font-weight: 700;
    }

    /* â”€â”€ ë§íˆ¬ í†¤ ìŠ¬ë¼ì´ë” â”€â”€ */
    .tone-wrap {
      margin-top: 6px;
    }

    .tone-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.72rem;
      color: #aaa;
      margin-bottom: 4px;
    }

    .tone-value {
      text-align: center;
      font-size: 0.78rem;
      color: #6c63ff;
      font-weight: 700;
      margin-top: 5px;
    }

    input[type=range] {
      width: 100%;
      accent-color: #6c63ff;
      cursor: pointer;
    }

    /* â”€â”€ í€´ì¦ˆ ì˜µì…˜ â”€â”€ */
    .quiz-section {
      margin-bottom: 18px;
    }

    .quiz-title {
      font-size: 0.85rem;
      font-weight: 700;
      color: #555;
      margin-bottom: 8px;
    }

    .opts {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 7px;
    }

    .opt-btn {
      padding: 11px 8px;
      border: 2px solid #ebebeb;
      border-radius: 10px;
      background: white;
      cursor: pointer;
      font-size: 0.78rem;
      text-align: center;
      transition: all 0.15s;
      color: #555;
      line-height: 1.4;
    }

    .opt-btn:hover {
      border-color: #b0acff;
    }

    .opt-btn.selected {
      border-color: #6c63ff;
      background: #edeaff;
      color: #6c63ff;
      font-weight: 700;
    }

    .opt-emoji {
      font-size: 1.2rem;
      display: block;
      margin-bottom: 3px;
    }

    /* â”€â”€ ë²„íŠ¼ â”€â”€ */
    .btn {
      width: 100%;
      padding: 13px;
      background: #6c63ff;
      color: white;
      border: none;
      border-radius: 10px;
      font-size: 0.97rem;
      font-weight: 700;
      cursor: pointer;
      transition: background 0.2s, transform 0.15s;
    }

    .btn:hover:not(:disabled) {
      background: #574fd6;
      transform: translateY(-1px);
    }

    .btn:disabled {
      background: #c5c2f0;
      cursor: not-allowed;
      transform: none;
    }

    .btn-ghost {
      width: 100%;
      padding: 10px;
      background: transparent;
      color: #aaa;
      border: none;
      font-size: 0.82rem;
      cursor: pointer;
      margin-top: 6px;
    }

    .btn-ghost:hover {
      color: #6c63ff;
    }

    /* â”€â”€ ì±„íŒ… â”€â”€ */
    .chat-wrap {
      width: 100%;
      max-width: 600px;
    }

    .chat-box {
      background: white;
      border-radius: 16px;
      padding: 20px;
      box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
    }

    .chat-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 14px;
      margin-bottom: 18px;
      border-bottom: 1px solid #f2f2f2;
    }

    .chat-title {
      font-weight: 700;
      font-size: 0.95rem;
      color: #1a1a2e;
    }

    .badges {
      display: flex;
      gap: 8px;
    }

    .badge {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 0.72rem;
      font-weight: 700;
    }

    .badge-a {
      background: #edeaff;
      color: #6c63ff;
    }

    .badge-b {
      background: #ffe8e8;
      color: #ff6b6b;
    }

    .messages {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    /* â”€â”€ í”¼ë“œë°± (ì¢‹ì•„ìš”/ì‹«ì–´ìš”) ë²„íŠ¼ â”€â”€ */
    .feedback-btns {
      display: flex;
      gap: 6px;
      margin-top: 4px;
      margin-left: 2px;
    }

    .feedback-btns button {
      background: none;
      border: none;
      cursor: pointer;
      font-size: 0.9rem;
      opacity: 0.5;
      transition: all 0.2s;
      padding: 2px 4px;
    }

    .feedback-btns button:hover {
      opacity: 1;
      transform: scale(1.1);
    }

    .feedback-btns button.active {
      opacity: 1;
      background: #edeaff;
      border-radius: 4px;
    }

    .msg {
      display: flex;
      align-items: flex-end;
      gap: 7px;
    }

    .msg.right {
      flex-direction: row-reverse;
    }

    .avatar {
      width: 34px;
      height: 34px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 800;
      font-size: 0.6rem;
      flex-shrink: 0;
      letter-spacing: -0.5px;
    }

    .avatar-a {
      background: #edeaff;
      color: #6c63ff;
    }

    .avatar-b {
      background: #ffe8e8;
      color: #ff6b6b;
    }

    .bubble {
      max-width: 72%;
      padding: 10px 14px;
      border-radius: 18px;
      font-size: 0.875rem;
      line-height: 1.6;
      color: #333;
    }

    .bubble-a {
      background: #f5f3ff;
      border-bottom-left-radius: 4px;
    }

    .bubble-b {
      background: #fff3f3;
      border-bottom-right-radius: 4px;
    }

    /* ë°œì‹ ì ì´ë¦„ ë ˆì´ë¸” */
    .msg-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
      max-width: 72%;
    }

    .sender-name {
      font-size: 0.68rem;
      color: #bbb;
      padding: 0 4px;
    }

    .msg.right .sender-name {
      text-align: right;
    }

    /* íƒ€ì´í•‘ ì»¤ì„œ */
    .cursor::after {
      content: '|';
      display: inline-block;
      margin-left: 1px;
      animation: blink 0.6s infinite;
      color: #bbb;
      font-weight: 300;
    }

    @keyframes blink {

      0%,
      100% {
        opacity: 1
      }

      50% {
        opacity: 0
      }
    }

    /* íƒ€ì´í•‘ ì  */
    .dots-wrap {
      padding: 10px 14px;
      border-radius: 18px;
      display: flex;
      gap: 4px;
      align-items: center;
    }

    .dots-wrap.side-a {
      background: #f5f3ff;
      border-bottom-left-radius: 4px;
    }

    .dots-wrap.side-b {
      background: #fff3f3;
      border-bottom-right-radius: 4px;
    }

    .d {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: #bbb;
      animation: bns 1.1s infinite;
    }

    .d:nth-child(2) {
      animation-delay: .18s
    }

    .d:nth-child(3) {
      animation-delay: .36s
    }

    @keyframes bns {

      0%,
      60%,
      100% {
        transform: translateY(0)
      }

      30% {
        transform: translateY(-5px)
      }
    }

    .hidden {
      display: none !important;
    }

    .divider {
      border: none;
      border-top: 1px solid #f0f0f0;
      margin: 14px 0;
    }
  </style>
</head>

<body>

  <h1>ë””í† ì±— ğŸ’¬</h1>
  <p class="subtitle">ë‚˜ì˜ ë””í† ì™€ ìƒëŒ€ë°©ì˜ ë””í† ê°€ ì²˜ìŒ ë§Œë‚˜ë©´?</p>


  <!-- ìŠ¤í… ì¸ë””ì¼€ì´í„° -->
  <div class="stepper" id="stepper">
    <div class="s-dot active" id="sd1">1</div>
    <div class="s-line" id="sl1"></div>
    <div class="s-dot" id="sd2">2</div>
    <div class="s-line" id="sl2"></div>
    <div class="s-dot" id="sd3">3</div>
    <div class="s-line" id="sl3"></div>
    <div class="s-dot" id="sd4">4</div>
    <div class="s-line" id="sl4"></div>
    <div class="s-dot" id="sd5">5</div>
    <span class="s-label active" id="stepLabel">ìƒë…„ì›”ì¼</span>
  </div>

  <!-- â”€â”€â”€ Step 1: ìƒë…„ì›”ì¼ â”€â”€â”€ -->
  <div class="card" id="step1">
    <div class="card-title">ê¸°ë³¸ ì •ë³´ ğŸ‚</div>
    <div class="card-sub">ìƒë…„ì›”ì¼ 6ìë¦¬ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</div>
    <div class="row">
      <div class="field half">
        <label>ì„±ë³„</label>
        <div style="display: flex; gap: 8px;">
          <button class="btn-ghost"
            style="border: 2px solid #ebebeb; border-radius: 10px; margin-top: 0; padding: 10px; color: #555;"
            id="btn-male" onclick="selectGender('ë‚¨ì')">ğŸ‘¨ ë‚¨ì</button>
          <button class="btn-ghost"
            style="border: 2px solid #ebebeb; border-radius: 10px; margin-top: 0; padding: 10px; color: #555;"
            id="btn-female" onclick="selectGender('ì—¬ì')">ğŸ‘© ì—¬ì</button>
        </div>
      </div>
      <div class="field half">
        <label>ìƒë…„ì›”ì¼ (ì˜ˆ: 060708)</label>
        <input type="text" id="a_birth" placeholder="YYMMDD" maxlength="6"
          oninput="this.value = this.value.replace(/[^0-9]/g, ''); checkStep1();">
      </div>
    </div>
    <button class="btn" onclick="go(2)" id="btn-s1" disabled>ë‹¤ìŒ â†’</button>
  </div>

  <!-- â”€â”€â”€ Step 2: ê±°ì£¼ì§€ â”€â”€â”€ -->
  <div class="card hidden" id="step2">
    <div class="card-title">ì‚¬ëŠ” ê³³ ğŸ </div>
    <div class="card-sub">í˜„ì¬ ê±°ì£¼ ì¤‘ì¸ ì§€ì—­ì„ ì„ íƒí•´ì£¼ì„¸ìš”</div>
    <div class="row">
      <div class="field full">
        <label>ê±°ì£¼ì§€</label>
        <select id="a_city" onchange="document.getElementById('btn-s2').disabled = !this.value">
          <option value="">ì„ íƒ</option>
          <option>ì„œìš¸</option>
          <option>ê²½ê¸°/ì¸ì²œ</option>
          <option>ê°•ì›</option>
          <option>ëŒ€ì „/ì¶©ì²­</option>
          <option>ëŒ€êµ¬/ê²½ë¶</option>
          <option>ë¶€ì‚°/ê²½ë‚¨</option>
          <option>ê´‘ì£¼/ì „ë¼</option>
          <option>ì œì£¼</option>
          <option>ê¸°íƒ€ ì§€ë°© í˜¹ì€ í•´ì™¸</option>
        </select>
      </div>
    </div>
    <button class="btn" onclick="go(3)" id="btn-s2" disabled>ë‹¤ìŒ â†’</button>
    <button class="btn-ghost" onclick="go(1)">â† ì´ì „</button>
  </div>

  <!-- â”€â”€â”€ Step 3: ì§ì—…/ìƒí™© â”€â”€â”€ -->
  <div class="card hidden" id="step3">
    <div class="card-title">ë‚˜ì˜ ìƒí™© ğŸ’¼</div>
    <div class="card-sub">í˜„ì¬ ì–´ë–¤ ì¼ì„ í•˜ê³  ê³„ì‹ ê°€ìš”?</div>
    <div class="field full">
      <label>ì§ì—…/ìƒí™©</label>
      <select id="a_job" onchange="document.getElementById('btn-s3').disabled = !this.value">
        <option value="">ì„ íƒ</option>
        <option value="í•™ìƒ">í•™ìƒ (ì´ˆ/ì¤‘/ê³ )</option>
        <option value="ëŒ€í•™ìƒ">ëŒ€í•™ìƒ</option>
        <option value="ì§ì¥ì¸">ì§ì¥ì¸</option>
        <option value="ê¸°íƒ€">ê¸°íƒ€ (í”„ë¦¬ëœì„œ, ì£¼ë¶€, ì·¨ì¤€ìƒ ë“±)</option>
      </select>
    </div>
    <button class="btn" onclick="go(4)" id="btn-s3" disabled>ë‹¤ìŒ â†’</button>
    <button class="btn-ghost" onclick="go(2)">â† ì´ì „</button>
  </div>

  <!-- â”€â”€â”€ Step 4: ëŒ€í™” ì£¼ì œ ì„ íƒ â”€â”€â”€ -->
  <div class="card hidden" id="step4">
    <div class="card-title">ì–´ë–¤ ëŒ€í™”ë¥¼ ë‚˜ëˆ ë³¼ê¹Œ? ğŸ’¬</div>
    <div class="card-sub">ê´€ì‹¬ ìˆëŠ” ëŒ€í™” ì£¼ì œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”</div>

    <div class="quiz-section">
      <div class="opts" id="topic_opts">
        <button class="opt-btn" data-topic="ì—°ì• "><span class="opt-emoji">ğŸ’•</span>ì—°ì• </button>
        <button class="opt-btn" data-topic="í•™ì—…"><span class="opt-emoji">ğŸ“š</span>í•™ì—…</button>
        <button class="opt-btn" data-topic="ì—…ë¬´"><span class="opt-emoji">ğŸ’¼</span>ì—…ë¬´</button>
        <button class="opt-btn" data-topic="ê²°í˜¼"><span class="opt-emoji">ğŸ’</span>ê²°í˜¼</button>
        <button class="opt-btn" data-topic="ì·¨ì—…"><span class="opt-emoji">ğŸ¯</span>ì·¨ì—…</button>
        <button class="opt-btn" data-topic="ê¸°íƒ€" id="btn-topic-other"><span class="opt-emoji">âœï¸</span>ê¸°íƒ€ (ì§ì ‘
          ì…ë ¥)</button>
      </div>
      <div id="topic-other-wrap" class="hidden" style="margin-top:10px;">
        <input type="text" id="topic-other-input" placeholder="ì–´ë–¤ ì£¼ì œë¡œ ëŒ€í™”í• ê¹Œìš”?" maxlength="20"
          style="width:100%; padding:10px; border-radius:10px; border:2px solid #ebebeb;"
          oninput="document.getElementById('btn-s4').disabled = this.value.trim() === ''; if(this.value.trim() !== '') selectedTopic = this.value.trim();">
      </div>
    </div>

    <button class="btn" onclick="go(5)" id="btn-s4" disabled>ë‹¤ìŒ â†’</button>
    <button class="btn-ghost" onclick="go(3)">â† ì´ì „</button>
  </div>

  <!-- â”€â”€â”€ Step 5: ì¹´ì¹´ì˜¤í†¡ ì»¨í…ìŠ¤íŠ¸ (ì„ íƒ í•­ëª©) â”€â”€â”€ -->
  <div class="card hidden" id="step5">
    <div class="card-title">ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” ë¶„ì„ ğŸ“±</div>
    <div class="card-sub" style="margin-bottom: 8px;">ë‚˜ì˜ ì‹¤ì œ ë§íˆ¬ë¥¼ ë¶„ì„í•´ì„œ ìë™ ì ìš©í•´ë“œë ¤ìš”! (ì„ íƒ)</div>

    <div class="quiz-section" style="margin-top: 20px;">
      <textarea id="kakao_text"
        style="width: 100%; height: 120px; padding: 10px; border: 2px solid #ebebeb; border-radius: 10px; font-size: 0.85rem; resize: none; margin-bottom: 8px;"
        placeholder="ì—¬ê¸°ì— ì¹´ì¹´ì˜¤í†¡ ëŒ€í™”ë¥¼ ë³µì‚¬í•´ì„œ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” (ìµœì†Œ 50ì ì´ìƒ)"></textarea>
      <div style="display: flex; gap: 10px; margin-bottom: 10px;">
        <button class="btn" style="flex: 1; background: #6c63ff; padding: 10px; font-size: 0.9rem;" id="btn-analyze"
          disabled>ëŒ€í™” ë¶„ì„í•˜ê¸° ğŸ”</button>
        <button class="btn"
          style="flex: 1; background: #fff; color: #6c63ff; border: 2px solid #6c63ff; padding: 10px; font-size: 0.9rem;"
          id="btn-upload" onclick="document.getElementById('file-upload').click()">txt íŒŒì¼ ì—…ë¡œë“œ ğŸ“</button>
        <input type="file" id="file-upload" accept=".txt" style="display: none;" onchange="handleFileUpload(event)">
      </div>
      <div id="analyze_result"
        style="margin-top: 10px; margin-bottom: 20px; font-size: 0.8rem; color: #6c63ff; font-weight: bold; text-align: center;">
      </div>
    </div>

    <!-- ë‹¤ìŒ/ê±´ë„ˆë›°ê¸° ë²„íŠ¼ -->
    <button class="btn" onclick="startMatching()" id="btn-s5" style="background: #20b2aa;">ê±´ë„ˆë›°ê¸° â†’</button>
    <button class="btn-ghost" onclick="go(4)" id="btn-prev-6">â† ì´ì „</button>
  </div>

  <!-- â”€â”€â”€ Step 6: ëŒ€í™” ìƒëŒ€ ì°¾ê¸° â”€â”€â”€ -->
  <div class="card hidden" id="step6">
    <div class="card-title">ëŒ€í™” ìƒëŒ€ ë§¤ì¹­ âœ¨</div>
    <div class="card-sub">ë‚˜ì™€ ê°€ì¥ ì˜ ë§ëŠ” ìƒëŒ€ë¥¼ ì—°ê²°í•©ë‹ˆë‹¤.</div>

    <div id="match-loading" style="text-align: center; margin: 40px 0;">
      <div style="font-size: 1.2rem; font-weight: bold; color: #6c63ff;" id="match-loading-text">ìš´ëª…ì˜ ìƒëŒ€ë¥¼ ì°¾ëŠ” ì¤‘...</div>
      <div style="font-size: 0.85rem; color: #999; margin-top: 10px;">ë‚˜ì´ Â±10ì„¸, MBTI ê¶í•© ê¸°ë°˜</div>
    </div>

    <div id="match-result" class="hidden" style="text-align: center; margin: 40px 0;">
      <div style="font-size: 1.3rem; margin-bottom: 10px; color: #333;" id="match-name">ë‚˜ì™€ ì˜ ë§ëŠ” <span id="match-gender"
          style="color:#6c63ff; font-weight:bold;">OO</span>ê°€ ë§¤ì¹­ë˜ì—ˆìŠµë‹ˆë‹¤!</div>
      <div style="font-size: 1.1rem; font-weight: bold; color: #6c63ff;" id="match-desc"></div>
    </div>

    <button class="btn hidden" id="btn-start" onclick="startChat()" style="margin-top: 15px;">ì´ ìƒëŒ€ì™€ ëŒ€í™” ì‹œì‘í•˜ê¸° âœ¨</button>
  </div>
  <!-- â”€â”€â”€ ì±„íŒ… â”€â”€â”€ -->
  <div class="chat-wrap hidden" id="chatWrap">
    <div class="chat-box">
      <div class="chat-header">
        <span class="chat-title" id="chatTitle">ì‹¤ì‹œê°„ ëŒ€í™” ì¤‘...</span>
        <div class="badges">
          <span class="badge badge-a" id="label1"></span>
          <span class="badge badge-b" id="label2"></span>
        </div>
      </div>
      <div class="messages" id="messages"></div>
    </div>
    <button class="btn-ghost" style="width:100%;margin-top:12px;" onclick="restart()">â†º ë‹¤ì‹œ ì„¤ì •í•˜ê¸°</button>
  </div>

  <script>

    const MBTI_LIST = ['ENFP', 'ENFJ', 'ENTP', 'ENTJ', 'INFP', 'INFJ', 'INTP', 'INTJ', 'ESFP', 'ESFJ', 'ESTP', 'ESTJ', 'ISFP', 'ISFJ', 'ISTP', 'ISTJ'];

    const COMPATIBILITY = {
      ENFP: ['INFJ', 'INTJ', 'ENFJ'], ENTP: ['INFP', 'INTP', 'ENFP'],
      ENFJ: ['INFP', 'ISFP', 'ENFP'], ENTJ: ['INTP', 'INTJ', 'INFJ'],
      ESFP: ['ISFJ', 'ISTJ', 'ESFJ'], ESTP: ['ISTP', 'ISTJ', 'ESTJ'],
      ESFJ: ['ISFP', 'ISFJ', 'ESFP'], ESTJ: ['ISTJ', 'ISTP', 'ESTP'],
      INFJ: ['ENFP', 'ENTP', 'ENFJ'], INTJ: ['ENFP', 'ENTJ', 'ENTP'],
      INFP: ['ENFJ', 'ENTP', 'ENFP'], INTP: ['ENTJ', 'ENTP', 'ESTJ'],
      ISFJ: ['ESFP', 'ESTP', 'ESFJ'], ISTJ: ['ESFP', 'ESTP', 'ESTJ'],
      ISFP: ['ENFJ', 'ESFJ', 'ESFP'], ISTP: ['ESTP', 'ESTJ', 'ENTJ'],
    };

    function pickMatch(mbti) {
      const list = COMPATIBILITY[mbti] || MBTI_LIST;
      return list[Math.floor(Math.random() * list.length)];
    }

    function calcAgeAndGen(birthStr) {
      if (!birthStr || birthStr.length < 6) return { ageStr: '', genStyle: '' };
      let yy = parseInt(birthStr.substring(0, 2), 10);
      const year = yy <= 24 ? 2000 + yy : 1900 + yy;
      const month = parseInt(birthStr.substring(2, 4), 10) - 1;
      const day = parseInt(birthStr.substring(4, 6), 10);

      const today = new Date();
      const birth = new Date(year, month, day);
      let age = today.getFullYear() - birth.getFullYear();
      const m = today.getMonth() - birth.getMonth();
      if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;

      let genStyle = '';
      if (year >= 2000) genStyle = 'ì‹ ì¡°ì–´ì™€ ì¤„ì„ë§ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì“°ê³ , ì§§ì€ ë¬¸ì¥ìœ¼ë¡œ ë§í•´. ë°ˆì´ë‚˜ ìœ í–‰ì–´ì— ë°˜ì‘í•´.';
      else if (year >= 1990) genStyle = 'ì´ëª¨í‹°ì½˜ì„ ì ì ˆíˆ ì“°ê³ , ì§ì¥ ìƒí™œì´ë‚˜ ì‚¬íšŒìƒí™œì— ê³µê°í•˜ëŠ” ì´ì•¼ê¸°ë¥¼ í•´.';
      else if (year >= 1980) genStyle = 'ìœ¡ì•„ë‚˜ ì¬í…Œí¬ ê°™ì€ ì†Œì¬ì— ê³µê°í•˜ê³ , ë¬¸ì¥í˜•ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ë§í•´.';
      else genStyle = 'ê²©ì‹ê³¼ êµ¬ì–´ì²´ë¥¼ ì ì ˆíˆ í˜¼ìš©í•˜ê³ , ê²½í—˜ë‹´ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì´ì•¼ê¸°í•´.';

      return { ageStr: `${age}ì‚´`, genStyle };
    }

    let analyzedStyle = "";
    const kakaoInput = document.getElementById('kakao_text');
    const btnAnalyze = document.getElementById('btn-analyze');
    const analyzeResult = document.getElementById('analyze_result');

    if (kakaoInput) kakaoInput.addEventListener('input', () => {
      btnAnalyze.disabled = kakaoInput.value.trim().length < 50;
    });

    if (btnAnalyze) btnAnalyze.addEventListener('click', () => {
      analyzeResult.textContent = 'ë¶„ì„ ì¤‘...';
      btnAnalyze.disabled = true;
      setTimeout(() => {
        analyzedStyle = kakaoInput.value.substring(0, 100);
        analyzeResult.textContent = 'âœ… ë¶„ì„ ì™„ë£Œ! ì„¤ì •ì— ë°˜ì˜ë˜ì—ˆìŠµë‹ˆë‹¤.';
      }, 1000);
    });

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function (e) {
          kakaoInput.value = e.target.result;
          btnAnalyze.disabled = kakaoInput.value.trim().length < 50;
          alert("íŒŒì¼ì´ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤. ë¶„ì„ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.");
        };
        reader.readAsText(file);
      }
    }

    let selectedTopic = null;
    document.querySelectorAll('#topic_opts .opt-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('#topic_opts .opt-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
        selectedTopic = btn.dataset.topic;
        document.getElementById('btn-s4').disabled = false;
      });
    });

    let selectedGender = null;
    function selectGender(gender) {
      selectedGender = gender;
      document.getElementById('btn-male').style.borderColor = gender === 'ë‚¨ì' ? '#6c63ff' : '#ebebeb';
      document.getElementById('btn-male').style.color = gender === 'ë‚¨ì' ? '#6c63ff' : '#555';
      document.getElementById('btn-female').style.borderColor = gender === 'ì—¬ì' ? '#6c63ff' : '#ebebeb';
      document.getElementById('btn-female').style.color = gender === 'ì—¬ì' ? '#6c63ff' : '#555';
      checkStep1();
    }

    function checkStep1() {
      const birthLen = document.getElementById('a_birth').value.length;
      document.getElementById('btn-s1').disabled = !(selectedGender && birthLen === 6);
    }

    const STEP_LABELS = ['', 'ê¸°ë³¸ ì •ë³´', 'ê±°ì£¼ì§€', 'ì§ì—…', 'ëŒ€í™” ì£¼ì œ', 'ì¹´ì¹´ì˜¤í†¡ ëŒ€í™” ë¶„ì„', 'ëŒ€í™” ìƒëŒ€ ë§¤ì¹­'];
    function go(n) {
      for (let i = 1; i <= 6; i++) {
        document.getElementById(`step${i}`)?.classList.toggle('hidden', i !== n);
      }
      document.getElementById('chatWrap').classList.add('hidden');
      document.getElementById('stepper').classList.remove('hidden');

      for (let i = 1; i <= 5; i++) {
        const dot = document.getElementById(`sd${i}`);
        const line = document.getElementById(`sl${i}`);

        // Since we have 6 visual steps but only 5 dots in the stepper, we can lock the stepper at 5 for the final steps
        let dotIndex = n > 5 ? 5 : n;
        dot?.classList.toggle('active', i === dotIndex);
        dot?.classList.toggle('done', i < dotIndex);
        line?.classList.toggle('done', i < dotIndex);
      }
      const lbl = document.getElementById('stepLabel');
      lbl.textContent = STEP_LABELS[n];
    }

    const sleep = ms => new Promise(r => setTimeout(r, ms));
    const esc = s => String(s).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');

    async function typeText(el, text) {
      el.textContent = '';
      el.classList.add('cursor');
      for (const ch of text) {
        el.textContent += ch;
        el.scrollIntoView({ block: 'end' });
        await sleep(26 + Math.random() * 22);
      }
      el.classList.remove('cursor');
    }

    const queue = [];
    let busy = false, isDone = false;
    let M1 = '', M2 = '';
    let M1name = 'ë‚˜', M2name = 'ìƒëŒ€ë°©';
    let matchBAge = '';

    function startMatching() {
      // Step 6 ì§„ì…
      go(6);

      M1 = MBTI_LIST[Math.floor(Math.random() * MBTI_LIST.length)];
      M2 = pickMatch(M1);

      document.getElementById('match-loading').classList.remove('hidden');
      document.getElementById('match-result').classList.add('hidden');
      document.getElementById('btn-start').classList.add('hidden');

      setTimeout(() => {
        document.getElementById('match-loading').classList.add('hidden');
        document.getElementById('match-result').classList.remove('hidden');

        // ìƒëŒ€ë°© ì„±ë³„ ê²°ì •: ë‚´ê°€ ë‚¨ìë©´ ì—¬ì, ì—¬ìë©´ ë‚¨ì
        const matchGenderStr = selectedGender === 'ë‚¨ì' ? 'ğŸ‘© ì—¬ì' : 'ğŸ‘¨ ë‚¨ì';
        document.getElementById('match-gender').textContent = matchGenderStr;

        const a_birth = document.getElementById('a_birth').value.trim();
        const { ageStr } = calcAgeAndGen(a_birth);
        if (ageStr) {
          const myAgeNum = parseInt(ageStr.match(/\d+/)[0]);
          const diff = Math.floor(Math.random() * 11) - 5; // Â±5ì„¸
          matchBAge = `${myAgeNum + diff}ì‚´`;
        }
        document.getElementById('match-desc').textContent = `ë‚˜ì´ ${matchBAge || '?'} Â· ìë™ MBTI ë§¤ì¹­ ì™„ë£Œ`;

        document.getElementById('btn-start').classList.remove('hidden');
      }, 1500);
    }

    async function processQueue() {
      if (busy || queue.length === 0) return;
      busy = true;
      removeTypingDots();

      const { mbti, text, isA, senderName } = queue.shift();
      const msgs = document.getElementById('messages');

      const row = document.createElement('div');
      row.className = `msg ${isA ? '' : 'right'}`;

      // ê³ ìœ  ë©”ì‹œì§€ ID (í”¼ë“œë°±ìš©)
      const msgId = 'msg-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
      row.dataset.msgId = msgId;

      const av = document.createElement('div');
      av.className = `avatar ${isA ? 'avatar-a' : 'avatar-b'}`;
      av.textContent = '#' + mbti.substring(0, 2);

      const group = document.createElement('div');
      group.className = 'msg-group';

      const name = document.createElement('div');
      name.className = 'sender-name';
      name.textContent = senderName;

      const bub = document.createElement('div');
      bub.className = `bubble ${isA ? 'bubble-a' : 'bubble-b'}`;

      group.appendChild(name);
      group.appendChild(bub);
      row.appendChild(av);
      row.appendChild(group);

      // ë‚´ê°€ ì•„ë‹Œ ìƒëŒ€ë°©(ë´‡)ì˜ ë©”ì‹œì§€ì¸ ê²½ìš°ì—ë§Œ ì¢‹ì•„ìš”/ì‹«ì–´ìš” ë²„íŠ¼ ì¶”ê°€
      if (!isA) {
        const fbGroup = document.createElement('div');
        fbGroup.className = 'feedback-btns';
        fbGroup.innerHTML = `
          <button onclick="sendFeedback('${msgId}', 'like', this)" title="ë‚˜ë‹¤ì›Œ">ğŸ‘</button>
          <button onclick="sendFeedback('${msgId}', 'dislike', this)" title="ì•„ë‹Œë°">ğŸ‘</button>
        `;
        group.appendChild(fbGroup);
      }

      msgs.appendChild(row);
      row.scrollIntoView({ behavior: 'smooth', block: 'end' });

      await typeText(bub, text);
      busy = false;

      if (queue.length > 0) {
        addTypingDots(!queue[0].isA);
        await sleep(180);
        processQueue();
      } else if (!isDone) {
        addTypingDots(!isA);
      }
    }

    function addTypingDots(isA) {
      removeTypingDots();
      const msgs = document.getElementById('messages');
      const row = document.createElement('div');
      row.id = 'typing-dots';
      row.className = `msg ${isA ? '' : 'right'}`;
      row.innerHTML = `<div class="avatar ${isA ? 'avatar-a' : 'avatar-b'}">${esc(isA ? '#' + M1.substring(0, 2) : '#' + M2.substring(0, 2))}</div>
    <div class="dots-wrap ${isA ? 'side-a' : 'side-b'}">
      <div class="d"></div><div class="d"></div><div class="d"></div>
    </div>`;
      msgs.appendChild(row);
      row.scrollIntoView({ behavior: 'smooth', block: 'end' });
    }
    function removeTypingDots() { document.getElementById('typing-dots')?.remove(); }

    let currentSrc = null;

    function startChat() {
      const a_birth = document.getElementById('a_birth').value.trim();
      const { ageStr: a_age, genStyle: a_genStyle } = calcAgeAndGen(a_birth);
      const a_city = document.getElementById('a_city').value;
      const a_job = document.getElementById('a_job').value;

      document.getElementById('step6').classList.add('hidden');
      document.getElementById('stepper').classList.add('hidden');
      document.getElementById('chatWrap').classList.remove('hidden');
      document.getElementById('label1').textContent = M1;
      document.getElementById('label2').textContent = M2;
      document.getElementById('messages').innerHTML = '';
      document.getElementById('chatTitle').textContent = `${M1} Ã— ${M2} ì‹¤ì‹œê°„ ëŒ€í™” ì¤‘...`;

      queue.length = 0; busy = false; isDone = false;
      addTypingDots(true);

      const p = new URLSearchParams({ mbti1: M1, mbti2: M2 });
      if (a_age) p.set('a_age', a_age);
      if (a_city && a_city !== 'ì„ íƒ') p.set('a_city', a_city);
      if (a_job && a_job !== 'ì„ íƒ') p.set('a_job', a_job);
      if (a_genStyle) p.set('a_genStyle', a_genStyle);
      if (matchBAge) p.set('b_age', matchBAge);
      if (selectedTopic) p.set('topic', selectedTopic);
      if (analyzedStyle) p.set('kakao_style', analyzedStyle);
      if (selectedGender) p.set('a_gender', selectedGender);

      if (currentSrc) currentSrc.close();
      const src = new EventSource(`/api/stream?${p}`);
      currentSrc = src;

      src.onmessage = (e) => {
        const data = JSON.parse(e.data);
        if (data.done) {
          isDone = true;
          if (!busy && queue.length === 0) {
            removeTypingDots();
            document.getElementById('chatTitle').textContent = 'ëŒ€í™” ì™„ë£Œ âœ…';
          }
          src.close(); return;
        }
        if (data.error) {
          removeTypingDots();
          const d = document.createElement('div');
          d.style.cssText = 'text-align:center;color:#e74c3c;padding:16px;font-size:0.82rem;';
          d.textContent = 'ì˜¤ë¥˜: ' + data.error;
          document.getElementById('messages').appendChild(d);
          src.close(); return;
        }
        if (data.mbti && data.text) {
          const isA = data.mbti === M1;
          queue.push({ mbti: data.mbti, text: data.text, isA, senderName: isA ? M1name : M2name });
          processQueue();
        }
      };

      src.onerror = () => { removeTypingDots(); src.close(); };
    }

    setInterval(() => {
      if (isDone && !busy && queue.length === 0) {
        removeTypingDots();
        const t = document.getElementById('chatTitle');
        if (t && t.textContent.includes('ì‹¤ì‹œê°„ ëŒ€í™” ì¤‘...')) t.textContent = `${M1} Ã— ${M2} ëŒ€í™” ì™„ë£Œ âœ…`;
      }
    }, 300);

    function restart() {
      if (currentSrc) currentSrc.close();
      document.getElementById('match-loading').classList.remove('hidden');
      document.getElementById('match-result').classList.add('hidden');
      document.getElementById('btn-start').classList.add('hidden');
      go(1);
    }

    /* â”€â”€ ë§íˆ¬ í•™ìŠµ í”¼ë“œë°± ì „ì†¡ â”€â”€ */
    async function sendFeedback(msgId, type, btnEl) {
      const container = btnEl.parentElement;
      container.querySelectorAll('button').forEach(b => b.classList.remove('active'));
      btnEl.classList.add('active');

      try {
        await fetch('/api/feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ msgId, type, text: container.parentElement.querySelector('.bubble').textContent })
        });
      } catch (err) {
        console.error('Feedback error:', err);
      }
    }

  </script>
</body>

</html>