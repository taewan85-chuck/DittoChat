<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
  <title>ë””í† ì±— â€” MBTI ë´‡ ëŒ€í™”</title>
  <style>
    /* â”€â”€ ë¦¬ì…‹ & ê¸°ë³¸ â”€â”€ */
    * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #f5f4ff;
      min-height: 100vh;
      display: flex; flex-direction: column; align-items: center;
      padding-bottom: 80px;
    }

    /* â”€â”€ ì•± í—¤ë” â”€â”€ */
    .app-header {
      width: 100%; max-width: 480px;
      padding: 28px 20px 10px;
      text-align: center;
    }
    .app-title { font-size: 1.6rem; font-weight: 900; color: #1a1a2e; letter-spacing: -1px; }
    .app-sub { font-size: 0.82rem; color: #aaa; margin-top: 4px; }

    /* â”€â”€ ìƒë‹¨ ì§„í–‰ ë°” (sticky) â”€â”€ */
    .top-bar {
      position: sticky; top: 0; z-index: 100;
      width: 100%; max-width: 480px;
      background: white;
      padding: 14px 20px 12px;
      box-shadow: 0 1px 8px rgba(0,0,0,0.07);
    }
    .top-row {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 10px;
    }
    .step-counter { font-size: 0.78rem; color: #bbb; font-weight: 600; }
    .step-counter strong { color: #6c63ff; font-size: 1rem; }
    .step-name { font-size: 0.85rem; font-weight: 800; color: #1a1a2e; }
    .progress-track {
      height: 6px; background: #ebebeb; border-radius: 99px; overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #6c63ff, #a78bfa);
      border-radius: 99px;
      transition: width 0.45s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* â”€â”€ ì»¨í…Œì´ë„ˆ â”€â”€ */
    .container {
      width: 100%; max-width: 480px;
      padding: 20px 16px;
    }

    /* â”€â”€ ì¹´ë“œ â”€â”€ */
    .card {
      background: white; border-radius: 20px;
      padding: 24px 20px;
      box-shadow: 0 2px 16px rgba(108,99,255,0.08);
      margin-bottom: 12px;
    }
    .card-title {
      font-weight: 800; font-size: 1.15rem; color: #1a1a2e;
      margin-bottom: 4px; letter-spacing: -0.3px;
    }
    .card-sub { font-size: 0.82rem; color: #bbb; margin-bottom: 20px; }

    /* â”€â”€ í¼ ìš”ì†Œ â”€â”€ */
    .field { display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px; }
    .field label { font-size: 0.78rem; font-weight: 700; color: #888; letter-spacing: 0.2px; }
    select, input[type=text] {
      padding: 14px 16px; border: 2px solid #ebebeb; border-radius: 12px;
      font-size: 1rem; background: white; color: #222;
      transition: border-color 0.2s; width: 100%; appearance: none;
    }
    select {
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%23aaa' stroke-width='1.5' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 16px center; padding-right: 40px;
    }
    select:focus, input:focus { outline: none; border-color: #6c63ff; }
    input::placeholder { color: #ccc; }
    .row2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    /* â”€â”€ ì„±ë³„ ë²„íŠ¼ â”€â”€ */
    .gender-row { display: flex; gap: 8px; }
    .gender-btn {
      flex: 1; padding: 16px 8px; border: 2px solid #ebebeb;
      border-radius: 12px; background: white; font-size: 0.88rem;
      font-weight: 700; color: #666; cursor: pointer;
      transition: all 0.15s; text-align: center;
    }
    .gender-btn:active { transform: scale(0.97); }
    .gender-btn.on { border-color: #6c63ff; background: #edeaff; color: #6c63ff; }

    /* â”€â”€ íƒœê·¸ (ë‹¤ì¤‘/ë‹¨ì¼ ì„ íƒ) â”€â”€ */
    .tags { display: flex; flex-wrap: wrap; gap: 8px; }
    .tag {
      padding: 11px 15px; border: 2px solid #ebebeb; border-radius: 22px;
      font-size: 0.83rem; font-weight: 600; cursor: pointer; background: white;
      transition: all 0.15s; color: #666; user-select: none;
    }
    .tag:active { transform: scale(0.96); }
    .tag.on { border-color: #6c63ff; background: #edeaff; color: #6c63ff; }

    /* â”€â”€ ì„¹ì…˜ â”€â”€ */
    .section { margin-bottom: 22px; }
    .section-title { font-size: 0.85rem; font-weight: 800; color: #333; margin-bottom: 10px; }
    hr.divider { border: none; border-top: 1px solid #f0f0f0; margin: 18px 0; }

    /* â”€â”€ ìŠ¬ë¼ì´ë” â”€â”€ */
    .slider-wrap { margin-top: 4px; }
    .slider-ends { display: flex; justify-content: space-between; font-size: 0.75rem; color: #aaa; margin-bottom: 8px; }
    input[type=range] { width: 100%; accent-color: #6c63ff; cursor: pointer; height: 28px; }
    .slider-val { text-align: center; font-size: 0.82rem; color: #6c63ff; font-weight: 700; margin-top: 4px; }

    /* â”€â”€ ì˜µì…˜ ì¹´ë“œ (ëŒ€í˜• í€´ì¦ˆ ë²„íŠ¼) â”€â”€ */
    .opt-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
    .opt-card {
      padding: 16px 10px; border: 2px solid #ebebeb; border-radius: 14px;
      background: white; cursor: pointer; text-align: center;
      transition: all 0.15s; color: #555;
    }
    .opt-card:active { transform: scale(0.97); }
    .opt-card.on { border-color: #6c63ff; background: #edeaff; color: #6c63ff; }
    .opt-emoji { font-size: 1.6rem; display: block; margin-bottom: 6px; }
    .opt-label { font-size: 0.8rem; font-weight: 700; line-height: 1.3; }

    /* â”€â”€ Step 5 ë‚˜ë¥¼ í•œ ì¤„ë¡œ â”€â”€ */
    .combo-preview {
      display: flex; align-items: center; flex-wrap: wrap; gap: 6px;
      font-size: 0.92rem; color: #555; line-height: 2.2;
      padding: 16px; background: #f7f6ff; border-radius: 14px; margin-bottom: 20px;
    }
    .combo-chip {
      background: #edeaff; color: #6c63ff; border-radius: 8px;
      padding: 4px 10px; font-weight: 800; font-size: 0.83rem;
      min-width: 72px; text-align: center;
      border: 2px dashed #b0acff; cursor: default;
    }
    .combo-chip.filled { background: #6c63ff; color: white; border-style: solid; border-color: #6c63ff; }
    .combo-group-title { font-size: 0.78rem; font-weight: 700; color: #aaa; margin-bottom: 8px; }
    .combo-opts { display: flex; flex-wrap: wrap; gap: 8px; }
    .combo-opt {
      padding: 11px 15px; border: 2px solid #ebebeb; border-radius: 22px;
      font-size: 0.82rem; font-weight: 700; cursor: pointer;
      background: white; color: #666; transition: all 0.15s;
    }
    .combo-opt:active { transform: scale(0.96); }
    .combo-opt.on { border-color: #6c63ff; background: #edeaff; color: #6c63ff; }

    /* â”€â”€ ë²„íŠ¼ (ëŒ€í˜•) â”€â”€ */
    .btn {
      width: 100%; padding: 18px; background: #6c63ff; color: white;
      border: none; border-radius: 14px; font-size: 1.05rem; font-weight: 800;
      cursor: pointer; transition: background 0.2s, transform 0.1s;
      letter-spacing: -0.2px;
    }
    .btn:hover:not(:disabled) { background: #574fd6; }
    .btn:active:not(:disabled) { transform: scale(0.98); }
    .btn:disabled { background: #c5c2f0; cursor: not-allowed; }
    .btn-ghost {
      width: 100%; padding: 16px; background: transparent; color: #aaa;
      border: 2px solid #ebebeb; border-radius: 14px;
      font-size: 0.9rem; font-weight: 700; cursor: pointer; margin-top: 8px;
      transition: all 0.15s;
    }
    .btn-ghost:active { transform: scale(0.98); }
    .btn-ghost:hover { border-color: #b0acff; color: #6c63ff; }
    .btn-wrap { display: flex; flex-direction: column; gap: 0; margin-top: 24px; }

    /* â”€â”€ ì±„íŒ… â”€â”€ */
    .chat-wrap { width: 100%; max-width: 480px; padding: 16px; }
    .chat-box {
      background: white; border-radius: 20px; padding: 20px;
      box-shadow: 0 2px 16px rgba(108,99,255,0.08);
    }
    .chat-header {
      display: flex; justify-content: space-between; align-items: center;
      padding-bottom: 14px; margin-bottom: 18px; border-bottom: 1px solid #f2f2f2;
    }
    .chat-title { font-weight: 800; font-size: 0.95rem; color: #1a1a2e; }
    .badges { display: flex; gap: 8px; }
    .badge { padding: 5px 12px; border-radius: 20px; font-size: 0.72rem; font-weight: 700; }
    .badge-a { background: #edeaff; color: #6c63ff; }
    .badge-b { background: #ffe8e8; color: #ff6b6b; }

    .messages { display: flex; flex-direction: column; gap: 10px; }
    .msg { display: flex; align-items: flex-end; gap: 7px; }
    .msg.right { flex-direction: row-reverse; }
    .avatar {
      width: 34px; height: 34px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: 800; font-size: 0.6rem; flex-shrink: 0; letter-spacing: -0.5px;
    }
    .avatar-a { background: #edeaff; color: #6c63ff; }
    .avatar-b { background: #ffe8e8; color: #ff6b6b; }
    .bubble { max-width: 75%; padding: 10px 14px; border-radius: 18px; font-size: 0.9rem; line-height: 1.6; color: #333; }
    .bubble-a { background: #f5f3ff; border-bottom-left-radius: 4px; }
    .bubble-b { background: #fff3f3; border-bottom-right-radius: 4px; }
    .msg-group { display: flex; flex-direction: column; gap: 3px; max-width: 75%; }
    .sender-name { font-size: 0.68rem; color: #bbb; padding: 0 4px; }
    .msg.right .sender-name { text-align: right; }

    /* íƒ€ì´í•‘ ì»¤ì„œ */
    .cursor::after { content: '|'; display: inline-block; margin-left: 1px; animation: blink 0.6s infinite; color: #bbb; font-weight: 300; }
    @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0} }
    .dots-wrap { padding: 10px 14px; border-radius: 18px; display: flex; gap: 4px; align-items: center; }
    .dots-wrap.side-a { background: #f5f3ff; border-bottom-left-radius: 4px; }
    .dots-wrap.side-b { background: #fff3f3; border-bottom-right-radius: 4px; }
    .d { width: 5px; height: 5px; border-radius: 50%; background: #bbb; animation: bns 1.1s infinite; }
    .d:nth-child(2){animation-delay:.18s} .d:nth-child(3){animation-delay:.36s}
    @keyframes bns { 0%,60%,100%{transform:translateY(0)} 30%{transform:translateY(-5px)} }

    .hidden { display: none !important; }
  </style>
</head>
<body>

<!-- ì•± í—¤ë” -->
<div class="app-header" id="appHeader">
  <div class="app-title">ë””í† ì±— ğŸ’¬</div>
  <div class="app-sub">ë‚˜ì˜ ë””í† ì™€ ìƒëŒ€ë°©ì˜ ë””í† ê°€ ì²˜ìŒ ë§Œë‚˜ë©´?</div>
</div>

<!-- ìƒë‹¨ ì§„í–‰ ë°” -->
<div class="top-bar" id="topBar">
  <div class="top-row">
    <span class="step-counter"><strong id="curStep">1</strong> / 6</span>
    <span class="step-name" id="stepName">ê¸°ë³¸ ì •ë³´</span>
  </div>
  <div class="progress-track">
    <div class="progress-fill" id="progressFill" style="width:16.66%"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• STEP 1: ê¸°ë³¸ ì •ë³´ â•â•â•â•â•â•â•â•â•â• -->
<div class="container" id="step1">
  <div class="card">
    <div class="card-title">ì•ˆë…•í•˜ì„¸ìš”! ğŸ‘‹</div>
    <div class="card-sub">ë‚˜ì˜ ë””í† ë¥¼ ë§Œë“¤ê¸° ìœ„í•œ ê¸°ë³¸ ì •ë³´ì˜ˆìš”</div>

    <div class="field">
      <label>ìƒë…„ì›”ì¼</label>
      <input type="text" id="a_birth" placeholder="YYYY-MM-DD" maxlength="10"
        oninput="formatBirthInput(this)">
    </div>

    <div class="field">
      <label>ì„±ë³„</label>
      <div class="gender-row">
        <button class="gender-btn" data-val="ë‚¨ì„±" onclick="selectGender(this)">ğŸ‘¦ ë‚¨ì„±</button>
        <button class="gender-btn" data-val="ì—¬ì„±" onclick="selectGender(this)">ğŸ‘§ ì—¬ì„±</button>
        <button class="gender-btn" data-val="ì„ íƒ ì•ˆ í•¨" onclick="selectGender(this)">ğŸ™‚ ë¬´ê´€</button>
      </div>
    </div>

    <div class="field">
      <label>ê±°ì£¼ì§€</label>
      <select id="a_city">
        <option value="">ì„ íƒ</option>
        <option>ì„œìš¸</option>
        <option>ê²½ê¸°/ì¸ì²œ</option>
        <option>ë¶€ì‚°</option>
        <option>ëŒ€êµ¬/ê²½ë¶</option>
        <option>ê´‘ì£¼/ì „ë¼</option>
        <option>ê¸°íƒ€ ì§€ë°©</option>
      </select>
    </div>

    <div class="btn-wrap">
      <button class="btn" onclick="go(2)">ë‹¤ìŒ â†’</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• STEP 2: MBTI â•â•â•â•â•â•â•â•â•â• -->
<div class="container hidden" id="step2">
  <div class="card">
    <div class="card-title">ë‚˜ì˜ MBTI ğŸ‘€</div>
    <div class="card-sub">ì–´ë–¤ ìœ í˜•ì¸ì§€ ì„ íƒí•´ì¤˜</div>

    <div class="field">
      <label>MBTI ìœ í˜•</label>
      <select id="mbti1">
        <!-- JSë¡œ ì±„ì›€ -->
      </select>
    </div>

    <p style="font-size:0.78rem;color:#aaa;margin-bottom:4px;">âœ¨ ìƒëŒ€ë°©ì€ ê¶í•© ëª©ë¡ì—ì„œ ìë™ ë§¤ì¹­ë¼ìš”</p>

    <div class="btn-wrap">
      <button class="btn" onclick="go(3)">ë‹¤ìŒ â†’</button>
      <button class="btn-ghost" onclick="go(1)">â† ì´ì „</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• STEP 3: ì„±ê²© ìŠ¤íƒ€ì¼ â•â•â•â•â•â•â•â•â•â• -->
<div class="container hidden" id="step3">
  <div class="card">
    <div class="card-title">ë‚˜ì˜ ì„±ê²© ìŠ¤íƒ€ì¼ âœ¨</div>
    <div class="card-sub">ì•„ë°”íƒ€ê°€ ë” ë‚˜ë‹µê²Œ ë§í•  ìˆ˜ ìˆì–´ìš”</div>

    <div class="section">
      <div class="section-title">ëŒ€í™” ìŠ¤íƒ€ì¼</div>
      <div class="tags" id="a_convStyle_tags">
        <span class="tag" data-val="ë¨¼ì € ë§ì„ ê±°ëŠ” í¸ì´ì•¼">ğŸ’¬ ë¨¼ì € ë§ ê±°ëŠ” í¸</span>
        <span class="tag" data-val="ë“£ë‹¤ê°€ ë§ì¥êµ¬ì¹˜ëŠ” í¸ì´ì•¼">ğŸ‘‚ ë“£ë‹¤ê°€ ë§ì¥êµ¬</span>
        <span class="tag" data-val="ê¹Šì€ ì£¼ì œë¥¼ ì„ í˜¸í•´">ğŸ’¡ ê¹Šì€ ì£¼ì œ ì„ í˜¸</span>
        <span class="tag" data-val="ê°€ë³ê³  ì¬ë°ŒëŠ” ëŒ€í™”ë¥¼ ì„ í˜¸í•´">ğŸ˜„ ê°€ë³ê³  ì¬ë°Œê²Œ</span>
      </div>
    </div>

    <hr class="divider">

    <div class="section">
      <div class="section-title">ê°ì • í‘œí˜„ ë°©ì‹</div>
      <div class="tags" id="a_emotionStyle_tags">
        <span class="tag" data-val="ê°ì •ì„ ë°”ë¡œ í‘œí˜„í•˜ëŠ” í¸ì´ì•¼">ğŸ˜Š ë°”ë¡œ í‘œí˜„</span>
        <span class="tag" data-val="ê°ì •ì„ ì†ìœ¼ë¡œ ì‚­íˆëŠ” í¸ì´ì•¼">ğŸ˜¶ ì†ìœ¼ë¡œ ì‚­í˜</span>
        <span class="tag" data-val="ìœ„ë¡œë°›ê³  ì‹¶ì–´">ğŸ¤— ìœ„ë¡œ ì›í•´</span>
        <span class="tag" data-val="í•´ê²°ì±…ì´ í•„ìš”í•´">ğŸ”§ í•´ê²°ì±… ì›í•´</span>
      </div>
    </div>

    <hr class="divider">

    <div class="section">
      <div class="section-title">ê´€ê³„ ìŠ¤íƒ€ì¼</div>
      <div class="tags" id="a_relStyle_tags">
        <span class="tag" data-val="ì†Œìˆ˜ì™€ ê¹Šì€ ê´€ê³„ë¥¼ ì„ í˜¸í•´">ğŸ¤ ì†Œìˆ˜ ê¹Šê²Œ</span>
        <span class="tag" data-val="ë„“ê³  ë‹¤ì–‘í•œ ê´€ê³„ë¥¼ ì„ í˜¸í•´">ğŸŒ ë„“ê³  ë‹¤ì–‘í•˜ê²Œ</span>
      </div>
    </div>

    <hr class="divider">

    <div class="section" style="margin-bottom:0;">
      <div class="section-title">ë§íˆ¬ í†¤</div>
      <div class="slider-wrap">
        <div class="slider-ends"><span>ğŸ˜„ ìœ ì¾Œí•¨</span><span>ğŸ§ ì§„ì§€í•¨</span></div>
        <input type="range" id="a_tone_slider" min="0" max="100" value="50"
          oninput="updateToneLabel(this.value)">
        <div class="slider-val" id="a_tone_label">ìœ ì¾Œí•¨ 50% Â· ì§„ì§€í•¨ 50%</div>
      </div>
    </div>

    <div class="btn-wrap">
      <button class="btn" onclick="go(4)">ë‹¤ìŒ â†’</button>
      <button class="btn-ghost" onclick="go(2)">â† ì´ì „</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• STEP 4: ê´€ì‹¬ì‚¬ & ì§ì—… â•â•â•â•â•â•â•â•â•â• -->
<div class="container hidden" id="step4">
  <div class="card">
    <div class="card-title">ê´€ì‹¬ì‚¬ & ì§ì—… ğŸ¯</div>
    <div class="card-sub">ì•„ë°”íƒ€ì˜ ëŒ€í™” ì£¼ì œ í’€ì´ ë§Œë“¤ì–´ì ¸ìš”</div>

    <div class="section">
      <div class="section-title">ì·¨ë¯¸ (ì—¬ëŸ¬ ê°œ ì„ íƒ ê°€ëŠ¥)</div>
      <div class="tags" id="a_hobbies_tags">
        <span class="tag" data-val="ìš´ë™/í—¬ìŠ¤">ğŸƒ ìš´ë™/í—¬ìŠ¤</span>
        <span class="tag" data-val="ê²Œì„">ğŸ® ê²Œì„</span>
        <span class="tag" data-val="ìœ íŠœë¸Œ/ë„·í”Œë¦­ìŠ¤">ğŸ“º ìœ íŠœë¸Œ/ë„·í”Œ</span>
        <span class="tag" data-val="ë…ì„œ">ğŸ“š ë…ì„œ</span>
        <span class="tag" data-val="ìŒì•…ê°ìƒ">ğŸµ ìŒì•…ê°ìƒ</span>
        <span class="tag" data-val="ìš”ë¦¬/ë§›ì§‘">ğŸ³ ìš”ë¦¬/ë§›ì§‘</span>
        <span class="tag" data-val="ì—¬í–‰">âœˆï¸ ì—¬í–‰</span>
        <span class="tag" data-val="ì¹´í˜">â˜• ì¹´í˜</span>
        <span class="tag" data-val="ì‡¼í•‘">ğŸ›ï¸ ì‡¼í•‘</span>
        <span class="tag" data-val="ê·¸ë¦¼/ì°½ì‘">ğŸ¨ ê·¸ë¦¼/ì°½ì‘</span>
        <span class="tag" data-val="ì¬í…Œí¬">ğŸ’° ì¬í…Œí¬</span>
        <span class="tag" data-val="ìê¸°ê³„ë°œ">ğŸ“ˆ ìê¸°ê³„ë°œ</span>
      </div>
    </div>

    <hr class="divider">

    <div class="field">
      <label>ì§ì—…/ìƒí™©</label>
      <select id="a_job" onchange="toggleDetail('a')">
        <option value="">ì„ íƒ</option>
        <option value="ê³ ë“±í•™ìƒ">ê³ ë“±í•™ìƒ</option>
        <option value="ëŒ€í•™ìƒ">ëŒ€í•™ìƒ</option>
        <option value="ì·¨ì¤€ìƒ">ì·¨ì¤€ìƒ (êµ¬ì§ ì¤‘)</option>
        <option value="ì§ì¥ì¸">ì§ì¥ì¸</option>
        <option value="í”„ë¦¬ëœì„œ">í”„ë¦¬ëœì„œ</option>
        <option value="ìì˜ì—…ì">ìì˜ì—…ì</option>
        <option value="ê¸°íƒ€">ê¸°íƒ€</option>
      </select>
    </div>

    <div class="field hidden" id="a_detail_wrap">
      <label id="a_detail_label">ì„¸ë¶€ ì •ë³´</label>
      <input type="text" id="a_detail" placeholder="ì˜ˆ: ê²½ì˜í•™ê³¼ 2í•™ë…„" maxlength="40">
    </div>

    <div class="btn-wrap">
      <button class="btn" onclick="go(5)">ë‹¤ìŒ â†’</button>
      <button class="btn-ghost" onclick="go(3)">â† ì´ì „</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• STEP 5: ë‚˜ë¥¼ í•œ ì¤„ë¡œ â•â•â•â•â•â•â•â•â•â• -->
<div class="container hidden" id="step5">
  <div class="card">
    <div class="card-title">ë‚˜ë¥¼ í•œ ì¤„ë¡œ ğŸª</div>
    <div class="card-sub">ì¡°ê°ì„ ê³¨ë¼ ìë™ìœ¼ë¡œ ì™„ì„±ë¼ìš”</div>

    <!-- ë¬¸ì¥ ë¯¸ë¦¬ë³´ê¸° -->
    <div class="combo-preview" id="comboPreview">
      ë‚˜ëŠ”&nbsp;
      <span class="combo-chip" id="chip1">?</span>
      <span class="combo-chip" id="chip2">?</span>
      ì´ê³ , ì£¼ë¡œ&nbsp;
      <span class="combo-chip" id="chip3">?</span>
      ì— ì—ë„ˆì§€ê°€ ì¶©ì „ë¼.
    </div>

    <div class="section">
      <div class="combo-group-title">â‘  ì„±ê²© ìœ í˜•</div>
      <div class="combo-opts" id="combo1_opts">
        <span class="combo-opt" data-group="1" data-val="í˜„ì‹¤ì ì¸">í˜„ì‹¤ì ì¸</span>
        <span class="combo-opt" data-group="1" data-val="ê°ì„±ì ì¸">ê°ì„±ì ì¸</span>
        <span class="combo-opt" data-group="1" data-val="ë…¼ë¦¬ì ì¸">ë…¼ë¦¬ì ì¸</span>
        <span class="combo-opt" data-group="1" data-val="ì—‰ëš±í•œ">ì—‰ëš±í•œ</span>
      </div>
    </div>

    <div class="section">
      <div class="combo-group-title">â‘¡ ìƒí™©</div>
      <div class="combo-opts" id="combo2_opts">
        <span class="combo-opt" data-group="2" data-val="ì§ì¥ì¸">ì§ì¥ì¸</span>
        <span class="combo-opt" data-group="2" data-val="í•™ìƒ">í•™ìƒ</span>
        <span class="combo-opt" data-group="2" data-val="ììœ ë¡œìš´ ì‚¬ëŒ">ììœ ë¡œìš´ ì‚¬ëŒ</span>
        <span class="combo-opt" data-group="2" data-val="ë¶€ëª¨">ë¶€ëª¨</span>
      </div>
    </div>

    <div class="section" style="margin-bottom:0;">
      <div class="combo-group-title">â‘¢ ì—ë„ˆì§€ ì¶©ì „</div>
      <div class="combo-opts" id="combo3_opts">
        <span class="combo-opt" data-group="3" data-val="í˜¼ì ìˆì„ ë•Œ">í˜¼ì ìˆì„ ë•Œ</span>
        <span class="combo-opt" data-group="3" data-val="ì‚¬ëŒë“¤ê³¼ í•¨ê»˜í•  ë•Œ">ì‚¬ëŒë“¤ê³¼ í•¨ê»˜í•  ë•Œ</span>
      </div>
    </div>

    <div class="btn-wrap">
      <button class="btn" onclick="go(6)">ë‹¤ìŒ â†’</button>
      <button class="btn-ghost" onclick="go(4)">â† ì´ì „</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• STEP 6: ìƒëŒ€ë°© + ì˜¤ëŠ˜ì˜ ë‚˜ â•â•â•â•â•â•â•â•â•â• -->
<div class="container hidden" id="step6">
  <div class="card">
    <div class="card-title">ìƒëŒ€ë°© ì„¤ì • ğŸ¤”</div>
    <div class="card-sub">ì–´ë–¤ ì‚¬ëŒê³¼ ëŒ€í™”í• ì§€ ê³¨ë¼ë´ (ì„ íƒì‚¬í•­)</div>

    <div class="row2">
      <div class="field">
        <label>ì—°ë ¹ëŒ€</label>
        <select id="b_age">
          <option value="">ëª¨ë¦„/ë¹„ìŠ·</option>
          <option>10ëŒ€</option>
          <option>20ëŒ€ ì´ˆë°˜</option>
          <option>20ëŒ€ í›„ë°˜</option>
          <option>30ëŒ€</option>
          <option>40ëŒ€ ì´ìƒ</option>
        </select>
      </div>
      <div class="field">
        <label>ì§ì—…/ìƒí™©</label>
        <select id="b_job" onchange="toggleDetail('b')">
          <option value="">ëª¨ë¦„/ììœ </option>
          <option value="ê³ ë“±í•™ìƒ">ê³ ë“±í•™ìƒ</option>
          <option value="ëŒ€í•™ìƒ">ëŒ€í•™ìƒ</option>
          <option value="ì·¨ì¤€ìƒ">ì·¨ì¤€ìƒ</option>
          <option value="ì§ì¥ì¸">ì§ì¥ì¸</option>
          <option value="í”„ë¦¬ëœì„œ">í”„ë¦¬ëœì„œ</option>
          <option value="ìì˜ì—…ì">ìì˜ì—…ì</option>
        </select>
      </div>
    </div>

    <div class="field hidden" id="b_detail_wrap">
      <label id="b_detail_label">ì„¸ë¶€ ì •ë³´</label>
      <input type="text" id="b_detail" placeholder="ì˜ˆ: ì»´í“¨í„°ê³µí•™ê³¼ 3í•™ë…„" maxlength="40">
    </div>
  </div>

  <div class="card">
    <div class="card-title">ì˜¤ëŠ˜ì˜ ë‚˜ ğŸŒ¤</div>
    <div class="card-sub">ëŒ€í™”ê°€ ë” ë‚˜ë‹µê²Œ í˜ëŸ¬ê°ˆ ê±°ì•¼</div>

    <div class="section">
      <div class="section-title">â‘  ì˜¤ëŠ˜ í•˜ë£¨ë¥¼ í•œë§ˆë””ë¡œ?</div>
      <div class="opt-grid" data-q="q1">
        <button class="opt-card" data-val="A"><span class="opt-emoji">ğŸ˜¤</span><span class="opt-label">ì •ì‹ ì—†ì´ ë°”ë¹´ì–´</span></button>
        <button class="opt-card" data-val="B"><span class="opt-emoji">ğŸ˜Œ</span><span class="opt-label">ì—¬ìœ ë¡­ê³  í‰ì˜¨í–ˆì–´</span></button>
        <button class="opt-card" data-val="C"><span class="opt-emoji">ğŸ˜©</span><span class="opt-label">í˜ë“¤ê³  ì§€ì³¤ì–´</span></button>
        <button class="opt-card" data-val="D"><span class="opt-emoji">ğŸ˜„</span><span class="opt-label">ê¸°ë¶„ ì¢‹ì€ ì¼ ìˆì—ˆì–´</span></button>
      </div>
    </div>

    <div class="section">
      <div class="section-title">â‘¡ ì§€ê¸ˆ ê°€ì¥ í•˜ê³  ì‹¶ì€ ê±´?</div>
      <div class="opt-grid" data-q="q2">
        <button class="opt-card" data-val="A"><span class="opt-emoji">ğŸ•</span><span class="opt-label">ë§›ìˆëŠ” ê±° ë¨¹ê¸°</span></button>
        <button class="opt-card" data-val="B"><span class="opt-emoji">ğŸ›‹ï¸</span><span class="opt-label">ê·¸ëƒ¥ ëˆ„ì›Œì„œ ì‰¬ê¸°</span></button>
        <button class="opt-card" data-val="C"><span class="opt-emoji">ğŸ®</span><span class="opt-label">ì¬ë¯¸ìˆëŠ” ê±° í•˜ê¸°</span></button>
        <button class="opt-card" data-val="D"><span class="opt-emoji">ğŸ’¬</span><span class="opt-label">ëˆ„êµ°ê°€ë‘ ìˆ˜ë‹¤ ë–¨ê¸°</span></button>
      </div>
    </div>

    <div class="section" style="margin-bottom:0;">
      <div class="section-title">â‘¢ ì˜¤ëŠ˜ ë‚˜ë¥¼ ê°€ì¥ ì˜ í‘œí˜„í•˜ëŠ” ê±´?</div>
      <div class="opt-grid" data-q="q3">
        <button class="opt-card" data-val="A"><span class="opt-emoji">ğŸ”¥</span><span class="opt-label">ì—´ì • ê°€ë“</span></button>
        <button class="opt-card" data-val="B"><span class="opt-emoji">ğŸ§Š</span><span class="opt-label">ì°¨ë¶„í•˜ê³  ëƒ‰ì •</span></button>
        <button class="opt-card" data-val="C"><span class="opt-emoji">ğŸŒŠ</span><span class="opt-label">ê°ì„± ì¶©ë§Œ</span></button>
        <button class="opt-card" data-val="D"><span class="opt-emoji">ğŸ’¡</span><span class="opt-label">ì•„ì´ë””ì–´ ë„˜ì¹¨</span></button>
      </div>
    </div>

    <div class="btn-wrap">
      <button class="btn" onclick="startChat()">âœ¨ ë””í†  ëŒ€í™” ì‹œì‘í•˜ê¸°</button>
      <button class="btn-ghost" onclick="go(5)">â† ì´ì „</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â• ì±„íŒ… â•â•â•â•â•â•â•â•â•â• -->
<div class="chat-wrap hidden" id="chatWrap">
  <div class="chat-box">
    <div class="chat-header">
      <span class="chat-title" id="chatTitle">ì‹¤ì‹œê°„ ëŒ€í™” ì¤‘...</span>
      <div class="badges">
        <span class="badge badge-a" id="label1"></span>
        <span class="badge badge-b" id="label2"></span>
      </div>
    </div>
    <div class="messages" id="messages"></div>
  </div>
  <button class="btn-ghost" style="width:100%;margin-top:12px;" onclick="restart()">â†º ë‹¤ì‹œ ì„¤ì •í•˜ê¸°</button>
</div>

<script>
/* â”€â”€ MBTI ì´ˆê¸°í™” â”€â”€ */
const MBTI_LIST = ['ENFP','ENFJ','ENTP','ENTJ','INFP','INFJ','INTP','INTJ','ESFP','ESFJ','ESTP','ESTJ','ISFP','ISFJ','ISTP','ISTJ'];
const sel1 = document.getElementById('mbti1');
MBTI_LIST.forEach(m => {
  const o = document.createElement('option');
  o.value = o.textContent = m;
  if (m === 'ENFP') o.selected = true;
  sel1.appendChild(o);
});

/* â”€â”€ ê¶í•© ëª©ë¡ â”€â”€ */
const COMPATIBILITY = {
  ENFP: ['INFJ','INTJ','ENFJ'],  ENTP: ['INFP','INTP','ENFP'],
  ENFJ: ['INFP','ISFP','ENFP'],  ENTJ: ['INTP','INTJ','INFJ'],
  ESFP: ['ISFJ','ISTJ','ESFJ'],  ESTP: ['ISTP','ISTJ','ESTJ'],
  ESFJ: ['ISFP','ISFJ','ESFP'],  ESTJ: ['ISTJ','ISTP','ESTP'],
  INFJ: ['ENFP','ENTP','ENFJ'],  INTJ: ['ENFP','ENTJ','ENTP'],
  INFP: ['ENFJ','ENTP','ENFP'],  INTP: ['ENTJ','ENTP','ESTJ'],
  ISFJ: ['ESFP','ESTP','ESFJ'],  ISTJ: ['ESFP','ESTP','ESTJ'],
  ISFP: ['ENFJ','ESFJ','ESFP'],  ISTP: ['ESTP','ESTJ','ENTJ'],
};
function pickMatch(mbti) {
  const list = COMPATIBILITY[mbti] || MBTI_LIST;
  return list[Math.floor(Math.random() * list.length)];
}

/* â”€â”€ ìƒë…„ì›”ì¼ í¬ë§· & ì„¸ëŒ€ â”€â”€ */
function formatBirthInput(el) {
  let v = el.value.replace(/\D/g, '');
  if (v.length > 4) v = v.slice(0,4) + '-' + v.slice(4);
  if (v.length > 7) v = v.slice(0,7) + '-' + v.slice(7);
  el.value = v.slice(0, 10);
}
function calcAgeAndGen(birthStr) {
  if (!birthStr || birthStr.length < 10) return { ageStr: '', genStyle: '' };
  const today = new Date();
  const birth = new Date(birthStr);
  if (isNaN(birth.getTime())) return { ageStr: '', genStyle: '' };
  let age = today.getFullYear() - birth.getFullYear();
  const m = today.getMonth() - birth.getMonth();
  if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
  const year = birth.getFullYear();
  let genStyle = '';
  if (year >= 2000) genStyle = 'ì‹ ì¡°ì–´ì™€ ì¤„ì„ë§ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì“°ê³ , ì§§ì€ ë¬¸ì¥ìœ¼ë¡œ ë§í•´. ë°ˆì´ë‚˜ ìœ í–‰ì–´ì— ë°˜ì‘í•´.';
  else if (year >= 1990) genStyle = 'ì´ëª¨í‹°ì½˜ì„ ì ì ˆíˆ ì“°ê³ , ì§ì¥ ìƒí™œì´ë‚˜ ì‚¬íšŒìƒí™œì— ê³µê°í•˜ëŠ” ì´ì•¼ê¸°ë¥¼ í•´.';
  else if (year >= 1980) genStyle = 'ìœ¡ì•„ë‚˜ ì¬í…Œí¬ ê°™ì€ ì†Œì¬ì— ê³µê°í•˜ê³ , ë¬¸ì¥í˜•ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ë§í•´.';
  else genStyle = 'ê²©ì‹ê³¼ êµ¬ì–´ì²´ë¥¼ ì ì ˆíˆ í˜¼ìš©í•˜ê³ , ê²½í—˜ë‹´ì„ ì¤‘ì‹¬ìœ¼ë¡œ ì´ì•¼ê¸°í•´.';
  return { ageStr: `${age}ì‚´`, genStyle };
}

/* â”€â”€ ì„±ë³„ ì„ íƒ â”€â”€ */
let selectedGender = '';
function selectGender(btn) {
  document.querySelectorAll('.gender-btn').forEach(b => b.classList.remove('on'));
  btn.classList.add('on');
  selectedGender = btn.dataset.val;
}

/* â”€â”€ ì§ì—… ì„¸ë¶€ í† ê¸€ â”€â”€ */
const DETAIL_LABELS = {
  'ëŒ€í•™ìƒ': 'ì „ê³µ & í•™ë…„ (ì˜ˆ: ê²½ì˜í•™ê³¼ 2í•™ë…„)',
  'ì§ì¥ì¸': 'ì§ì¢… & íšŒì‚¬ ê·œëª¨ (ì˜ˆ: ITìŠ¤íƒ€íŠ¸ì—… ê°œë°œì)',
  'ê³ ë“±í•™ìƒ': 'í•™êµ íŠ¹ì§• (ì˜ˆ: ì˜ˆìˆ ê³  2í•™ë…„)',
  'ì·¨ì¤€ìƒ': 'ì¤€ë¹„ ë¶„ì•¼ (ì˜ˆ: ê³µë¬´ì› ì‹œí—˜ ì¤€ë¹„ ì¤‘)',
  'í”„ë¦¬ëœì„œ': 'ì£¼ìš” ì—…ë¬´ (ì˜ˆ: ì˜ìƒí¸ì§‘ í”„ë¦¬ëœì„œ)',
  'ìì˜ì—…ì': 'ì—…ì¢… (ì˜ˆ: ì¹´í˜ ìš´ì˜)',
  'ê¸°íƒ€': 'í•˜ëŠ” ì¼ (ììœ  ì…ë ¥)',
};
function toggleDetail(prefix) {
  const job  = document.getElementById(`${prefix}_job`).value;
  const wrap  = document.getElementById(`${prefix}_detail_wrap`);
  const label = document.getElementById(`${prefix}_detail_label`);
  const show  = !!job;
  wrap.classList.toggle('hidden', !show);
  if (show) {
    label.textContent = DETAIL_LABELS[job] || 'ì„¸ë¶€ ì •ë³´';
    document.getElementById(`${prefix}_detail`).placeholder =
      job === 'ëŒ€í•™ìƒ' ? 'ì˜ˆ: ê²½ì˜í•™ê³¼ 2í•™ë…„' :
      job === 'ì§ì¥ì¸' ? 'ì˜ˆ: ITìŠ¤íƒ€íŠ¸ì—… ê°œë°œì' :
      job === 'ì·¨ì¤€ìƒ' ? 'ì˜ˆ: ê³µë¬´ì› ì‹œí—˜ ì¤€ë¹„ ì¤‘' : 'ììœ  ì…ë ¥';
  }
}

/* â”€â”€ ë‹¨ì¼ ì„ íƒ íƒœê·¸ â”€â”€ */
['a_convStyle_tags', 'a_emotionStyle_tags', 'a_relStyle_tags'].forEach(groupId => {
  document.querySelectorAll(`#${groupId} .tag`).forEach(tag => {
    tag.addEventListener('click', () => {
      document.querySelectorAll(`#${groupId} .tag`).forEach(t => t.classList.remove('on'));
      tag.classList.add('on');
    });
  });
});

/* â”€â”€ ë‹¤ì¤‘ ì„ íƒ íƒœê·¸ â”€â”€ */
document.querySelectorAll('#a_hobbies_tags .tag').forEach(tag => {
  tag.addEventListener('click', () => tag.classList.toggle('on'));
});

/* â”€â”€ ë§íˆ¬ í†¤ ìŠ¬ë¼ì´ë” â”€â”€ */
function updateToneLabel(val) {
  const fun = parseInt(val);
  document.getElementById('a_tone_label').textContent = `ìœ ì¾Œí•¨ ${fun}% Â· ì§„ì§€í•¨ ${100 - fun}%`;
}

/* â”€â”€ ë‚˜ë¥¼ í•œ ì¤„ë¡œ (Step 5) â”€â”€ */
const comboState = { 1: '', 2: '', 3: '' };
document.querySelectorAll('.combo-opt').forEach(opt => {
  opt.addEventListener('click', () => {
    const group = opt.dataset.group;
    document.querySelectorAll(`.combo-opt[data-group="${group}"]`).forEach(o => o.classList.remove('on'));
    opt.classList.add('on');
    comboState[group] = opt.dataset.val;
    updateComboPreview();
  });
});
function updateComboPreview() {
  [['chip1', comboState[1]], ['chip2', comboState[2]], ['chip3', comboState[3]]].forEach(([id, val]) => {
    const el = document.getElementById(id);
    el.textContent = val || '?';
    el.classList.toggle('filled', !!val);
  });
}

/* â”€â”€ í€´ì¦ˆ ì„ íƒ â”€â”€ */
const answers = { q1: null, q2: null, q3: null };
document.querySelectorAll('.opt-grid').forEach(group => {
  group.querySelectorAll('.opt-card').forEach(btn => {
    btn.addEventListener('click', () => {
      group.querySelectorAll('.opt-card').forEach(b => b.classList.remove('on'));
      btn.classList.add('on');
      answers[group.dataset.q] = btn.dataset.val;
    });
  });
});

/* â”€â”€ ìŠ¤í… ì´ë™ & ì§„í–‰ ë°” â”€â”€ */
const STEP_META = [
  null,
  { name: 'ê¸°ë³¸ ì •ë³´',      pct: 16.66 },
  { name: 'MBTI ì„ íƒ',      pct: 33.33 },
  { name: 'ì„±ê²© ìŠ¤íƒ€ì¼',    pct: 50    },
  { name: 'ê´€ì‹¬ì‚¬ & ì§ì—…',  pct: 66.66 },
  { name: 'ë‚˜ë¥¼ í•œ ì¤„ë¡œ',   pct: 83.33 },
  { name: 'ìƒëŒ€ë°© & ì˜¤ëŠ˜',  pct: 100   },
];
function go(n) {
  for (let i = 1; i <= 6; i++) {
    document.getElementById(`step${i}`)?.classList.toggle('hidden', i !== n);
  }
  document.getElementById('chatWrap').classList.add('hidden');
  document.getElementById('topBar').classList.remove('hidden');
  document.getElementById('appHeader').classList.remove('hidden');

  const meta = STEP_META[n];
  document.getElementById('curStep').textContent = n;
  document.getElementById('stepName').textContent = meta.name;
  document.getElementById('progressFill').style.width = meta.pct + '%';

  window.scrollTo({ top: 0, behavior: 'smooth' });
}

/* â”€â”€ ìœ í‹¸ â”€â”€ */
const sleep = ms => new Promise(r => setTimeout(r, ms));
const esc   = s  => String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');

/* â”€â”€ íƒ€ì´í•‘ ì• ë‹ˆë©”ì´ì…˜ â”€â”€ */
async function typeText(el, text) {
  el.textContent = '';
  el.classList.add('cursor');
  for (const ch of text) {
    el.textContent += ch;
    el.scrollIntoView({ block: 'end' });
    await sleep(26 + Math.random() * 22);
  }
  el.classList.remove('cursor');
}

/* â”€â”€ ë©”ì‹œì§€ í â”€â”€ */
const queue = [];
let busy = false, isDone = false;
let M1 = '', M2 = '';
let M1name = '', M2name = '';

async function processQueue() {
  if (busy || queue.length === 0) return;
  busy = true;
  removeTypingDots();

  const { mbti, text, isA, senderName } = queue.shift();
  const msgs = document.getElementById('messages');

  const row   = document.createElement('div');
  row.className = `msg ${isA ? '' : 'right'}`;

  const av = document.createElement('div');
  av.className = `avatar ${isA ? 'avatar-a' : 'avatar-b'}`;
  av.textContent = mbti;

  const group = document.createElement('div');
  group.className = 'msg-group';

  const name = document.createElement('div');
  name.className = 'sender-name';
  name.textContent = senderName;

  const bub = document.createElement('div');
  bub.className = `bubble ${isA ? 'bubble-a' : 'bubble-b'}`;

  group.appendChild(name);
  group.appendChild(bub);
  row.appendChild(av);
  row.appendChild(group);
  msgs.appendChild(row);
  row.scrollIntoView({ behavior: 'smooth', block: 'end' });

  await typeText(bub, text);
  busy = false;

  if (queue.length > 0) {
    addTypingDots(!queue[0].isA);
    await sleep(180);
    processQueue();
  } else if (!isDone) {
    addTypingDots(!isA);
  }
}

function addTypingDots(isA) {
  removeTypingDots();
  const msgs = document.getElementById('messages');
  const row  = document.createElement('div');
  row.id = 'typing-dots';
  row.className = `msg ${isA ? '' : 'right'}`;
  row.innerHTML = `
    <div class="avatar ${isA ? 'avatar-a' : 'avatar-b'}">${esc(isA ? M1 : M2)}</div>
    <div class="dots-wrap ${isA ? 'side-a' : 'side-b'}">
      <div class="d"></div><div class="d"></div><div class="d"></div>
    </div>`;
  msgs.appendChild(row);
  row.scrollIntoView({ behavior: 'smooth', block: 'end' });
}
function removeTypingDots() { document.getElementById('typing-dots')?.remove(); }

/* â”€â”€ ì±„íŒ… ì‹œì‘ â”€â”€ */
let currentSrc = null;

function startChat() {
  M1 = document.getElementById('mbti1').value;
  M2 = pickMatch(M1);

  const a_birth  = document.getElementById('a_birth').value.trim();
  const { ageStr: a_age, genStyle: a_genStyle } = calcAgeAndGen(a_birth);
  const a_city   = document.getElementById('a_city').value;
  const a_job    = document.getElementById('a_job').value;
  const a_detail = document.getElementById('a_detail').value.trim();
  const a_hobbies = [...document.querySelectorAll('#a_hobbies_tags .tag.on')]
                      .map(t => t.dataset.val).join(',');

  const b_age    = document.getElementById('b_age').value;
  const b_job    = document.getElementById('b_job').value;
  const b_detail = document.getElementById('b_detail').value.trim();

  const a_convStyle    = document.querySelector('#a_convStyle_tags .tag.on')?.dataset.val || '';
  const a_emotionStyle = document.querySelector('#a_emotionStyle_tags .tag.on')?.dataset.val || '';
  const a_relStyle     = document.querySelector('#a_relStyle_tags .tag.on')?.dataset.val || '';
  const toneVal = document.getElementById('a_tone_slider').value;
  const a_tone  = `ìœ ì¾Œí•¨ ${toneVal}%, ì§„ì§€í•¨ ${100 - toneVal}%`;

  const comboSentence = (comboState[1] && comboState[2] && comboState[3])
    ? `ë‚˜ëŠ” ${comboState[1]} ${comboState[2]}ì´ê³ , ì£¼ë¡œ ${comboState[3]}ì— ì—ë„ˆì§€ê°€ ì¶©ì „ë¼.`
    : '';

  M1name = [a_age, a_city, a_job].filter(Boolean).join(' Â· ') || M1;
  M2name = [b_age, b_job].filter(Boolean).join(' Â· ') || M2;

  // UI ì „í™˜
  for (let i = 1; i <= 6; i++) document.getElementById(`step${i}`)?.classList.add('hidden');
  document.getElementById('topBar').classList.add('hidden');
  document.getElementById('appHeader').classList.add('hidden');
  document.getElementById('chatWrap').classList.remove('hidden');
  document.getElementById('label1').textContent = M1;
  document.getElementById('label2').textContent = M2;
  document.getElementById('messages').innerHTML = '';
  document.getElementById('chatTitle').textContent = `${M1} Ã— ${M2} ì‹¤ì‹œê°„ ëŒ€í™” ì¤‘...`;

  queue.length = 0; busy = false; isDone = false;
  addTypingDots(true);

  // SSE íŒŒë¼ë¯¸í„° êµ¬ì„±
  const p = new URLSearchParams({ mbti1: M1, mbti2: M2 });
  if (a_age)          p.set('a_age', a_age);
  if (a_city)         p.set('a_city', a_city);
  if (a_job)          p.set('a_job', a_job);
  if (a_detail)       p.set('a_detail', a_detail);
  if (a_hobbies)      p.set('a_hobbies', a_hobbies);
  if (a_convStyle)    p.set('a_convStyle', a_convStyle);
  if (a_emotionStyle) p.set('a_emotionStyle', a_emotionStyle);
  if (a_relStyle)     p.set('a_relStyle', a_relStyle);
  if (a_genStyle)     p.set('a_genStyle', a_genStyle);
  if (comboSentence)  p.set('a_combo', comboSentence);
  if (selectedGender) p.set('a_gender', selectedGender);
  p.set('a_tone', a_tone);
  if (b_age)    p.set('b_age', b_age);
  if (b_job)    p.set('b_job', b_job);
  if (b_detail) p.set('b_detail', b_detail);
  if (answers.q1) p.set('q1', answers.q1);
  if (answers.q2) p.set('q2', answers.q2);
  if (answers.q3) p.set('q3', answers.q3);

  if (currentSrc) currentSrc.close();
  const src = new EventSource(`/api/stream?${p}`);
  currentSrc = src;

  src.onmessage = (e) => {
    const data = JSON.parse(e.data);
    if (data.done) {
      isDone = true;
      if (!busy && queue.length === 0) {
        removeTypingDots();
        document.getElementById('chatTitle').textContent = 'ëŒ€í™” ì™„ë£Œ âœ…';
      }
      src.close(); return;
    }
    if (data.error) {
      removeTypingDots();
      const d = document.createElement('div');
      d.style.cssText = 'text-align:center;color:#e74c3c;padding:16px;font-size:0.82rem;';
      d.textContent = 'ì˜¤ë¥˜: ' + data.error;
      document.getElementById('messages').appendChild(d);
      src.close(); return;
    }
    if (data.mbti && data.text) {
      const isA = data.mbti === M1;
      queue.push({ mbti: data.mbti, text: data.text, isA, senderName: isA ? M1name : M2name });
      processQueue();
    }
  };

  src.onerror = () => { removeTypingDots(); src.close(); };
}

/* â”€â”€ ì™„ë£Œ ì²´í¬ â”€â”€ */
setInterval(() => {
  if (isDone && !busy && queue.length === 0) {
    removeTypingDots();
    const t = document.getElementById('chatTitle');
    if (t && t.textContent.includes('ì‹¤ì‹œê°„ ëŒ€í™” ì¤‘...'))
      t.textContent = `${M1} Ã— ${M2} ëŒ€í™” ì™„ë£Œ âœ…`;
  }
}, 300);

/* â”€â”€ ë‹¤ì‹œ ì„¤ì • â”€â”€ */
function restart() {
  if (currentSrc) currentSrc.close();
  go(1);
}
</script>
</body>
</html>
